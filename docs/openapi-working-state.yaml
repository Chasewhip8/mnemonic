openapi: 3.1.0
info:
  title: deja Working State API
  version: 1.1.0
  description: Durable recall + live working-state endpoints for active runs.
servers:
  - url: https://deja.example.workers.dev
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API key
  schemas:
    WorkingStatePayload:
      type: object
      properties:
        goal:
          type: string
        assumptions:
          type: array
          items: { type: string }
        decisions:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              text: { type: string }
              status: { type: string }
            required: [text]
        open_questions:
          type: array
          items: { type: string }
        next_actions:
          type: array
          items: { type: string }
        confidence:
          type: number
    WorkingStateResponse:
      type: object
      properties:
        runId: { type: string }
        revision: { type: integer }
        status: { type: string, enum: [active, resolved] }
        state:
          $ref: '#/components/schemas/WorkingStatePayload'
        updatedBy: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        resolvedAt: { type: string, format: date-time }
      required: [runId, revision, status, state, createdAt, updatedAt]
security:
  - bearerAuth: []
paths:
  /state/{runId}:
    get:
      summary: Get live working state for a run.
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: State found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/WorkingStateResponse' }
        '404':
          description: Not found
    put:
      summary: Upsert full live state for a run.
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/WorkingStatePayload'
                - type: object
                  properties:
                    updatedBy: { type: string }
                    changeSummary: { type: string }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/WorkingStateResponse' }
    patch:
      summary: Patch live state for a run.
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/WorkingStatePayload'
                - type: object
                  properties:
                    updatedBy: { type: string }
      responses:
        '200':
          description: Patched
          content:
            application/json:
              schema: { $ref: '#/components/schemas/WorkingStateResponse' }

  /state/{runId}/events:
    post:
      summary: Append immutable state event.
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                eventType: { type: string }
                payload: { type: object, additionalProperties: true }
                createdBy: { type: string }
      responses:
        '200':
          description: Event appended

  /state/{runId}/resolve:
    post:
      summary: Mark state resolved, optionally persist compact learning.
      parameters:
        - in: path
          name: runId
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                persistToLearn: { type: boolean, default: false }
                scope: { type: string, default: shared }
                summaryStyle: { type: string, enum: [compact, full], default: compact }
                updatedBy: { type: string }
      responses:
        '200':
          description: Resolved
          content:
            application/json:
              schema: { $ref: '#/components/schemas/WorkingStateResponse' }
        '404':
          description: Not found

  /inject:
    post:
      summary: Retrieve relevant learnings and optional live state context.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                context: { type: string }
                scopes:
                  type: array
                  items: { type: string }
                limit: { type: integer, default: 5 }
                format: { type: string, enum: [prompt, learnings], default: prompt }
                includeState: { type: boolean, default: false }
                runId: { type: string }
              required: [context]
      responses:
        '200':
          description: Retrieved
