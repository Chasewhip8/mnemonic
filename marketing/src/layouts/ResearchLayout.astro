---
import Base from './Base.astro';
import SEO from '../components/SEO.astro';
import { concepts, layers, getAdjacentConcepts } from '../data/research';
import type { ResearchConcept } from '../data/research';

interface Props {
  concept: ResearchConcept;
}

const { concept } = Astro.props;
const { prev, next } = getAdjacentConcepts(concept.slug);

const layerConcepts = concepts.filter(c => c.layer === concept.layer);
const layerInfo = layers[concept.layer];

const grouped = {
  a: concepts.filter(c => c.layer === 'a'),
  b: concepts.filter(c => c.layer === 'b'),
  c: concepts.filter(c => c.layer === 'c'),
};
---

<Base title={`${concept.title} — Memory Interface Research — deja`} variant="content">
  <SEO
    slot="head"
    title={`${concept.title} — Memory Interface Research — deja`}
    description={concept.description}
    keywords={concept.keywords}
    path={`/research/${concept.slug}`}
    type="article"
    section="Research"
    tags={concept.keywords.split(', ')}
    breadcrumbs={[
      { name: 'Research', path: '/research' },
      { name: `Layer ${concept.layer.toUpperCase()}`, path: `/research#layer-${concept.layer}` },
      { name: concept.title, path: `/research/${concept.slug}` },
    ]}
  />

  <div class="pt-12 pb-8 xl:grid xl:grid-cols-[minmax(220px,240px)_1fr_minmax(140px,160px)] xl:gap-6 2xl:gap-8">
    <!-- Left sidebar: all concepts -->
    <aside class="hidden xl:block min-w-0">
      <nav class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto overflow-x-hidden pr-2 research-sidebar">
        <a href="/research" class="block font-mono text-[10px] font-bold tracking-widest uppercase text-brass mb-4 hover:text-brass-light transition-colors">
          Research
        </a>
        {Object.entries(grouped).map(([layer, items]) => (
          <div class="mb-4">
            <div class="font-mono text-[9px] font-bold tracking-widest uppercase text-chrome-dark/30 mb-1.5 px-2">
              Layer {layer.toUpperCase()} · {layers[layer as 'a'|'b'|'c'].range}
            </div>
            {items.map(item => (
              <a
                href={`/research/${item.slug}`}
                class:list={[
                  'block py-1.5 px-2 text-[12px] font-serif transition-colors border-l-2 leading-snug wrap-break-word',
                  item.slug === concept.slug
                    ? 'text-brass border-brass bg-brass/5 font-medium'
                    : 'text-chrome-dark/50 border-transparent hover:text-chrome hover:border-brass/30',
                ]}
              >
                <span class="font-mono text-[9px] text-chrome-dark/30 mr-1 shrink-0">{String(item.number).padStart(2, '0')}</span>
                {item.title.replace('The ', '')}
              </a>
            ))}
          </div>
        ))}
      </nav>
    </aside>

    <!-- Center: main content -->
    <div class="min-w-0">
      <!-- Breadcrumbs -->
      <nav class="font-mono text-[11px] text-chrome-dark/50 mb-6 flex items-center gap-1.5 flex-wrap">
        <a href="/" class="hover:text-brass transition-colors">Home</a><span class="text-chrome-dark/30">/</span>
        <a href="/research" class="hover:text-brass transition-colors">Research</a><span class="text-chrome-dark/30">/</span>
        <span class="text-chrome-dark/70">{concept.title}</span>
      </nav>

      <!-- Concept header -->
      <header class="mb-10">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-[11px] font-bold tracking-widest px-2.5 py-1 rounded-sm bg-brass/10 text-brass border border-brass/20">
            {String(concept.number).padStart(2, '0')} / 20
          </span>
          <span class="font-mono text-[10px] tracking-widest uppercase text-chrome-dark/40">
            Layer {concept.layer.toUpperCase()} · {layerInfo.title}
          </span>
        </div>
        <h1 class="font-serif-sc text-3xl md:text-5xl font-bold tracking-tight m-0 mb-3 wrap-break-word">
          {concept.title}
        </h1>
        <p class="font-serif text-xl text-chrome-dark m-0 max-w-2xl leading-relaxed">
          {concept.tagline}
        </p>
      </header>

      <!-- Demo slot -->
      <slot name="demo" />

      <!-- Main content -->
      <article class="prose-deja mt-12">
        <slot />
      </article>

      <!-- Related concepts in same layer -->
      <div class="mt-16 pt-8 border-t border-brass/10">
        <div class="font-mono text-[10px] font-bold tracking-widest uppercase text-brass/60 mb-4">
          More in Layer {concept.layer.toUpperCase()} · {layerInfo.title}
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {layerConcepts.filter(c => c.slug !== concept.slug).slice(0, 4).map(c => (
            <a href={`/research/${c.slug}`} class="group block bg-steel/50 border border-brass/10 rounded-sm p-4 hover:border-brass/20 transition-colors">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-mono text-[9px] text-chrome-dark/30">{String(c.number).padStart(2, '0')}</span>
                <span class="font-serif text-sm font-medium group-hover:text-brass transition-colors">{c.title}</span>
              </div>
              <p class="font-serif text-[12px] text-chrome-dark/50 m-0 leading-relaxed">{c.tagline}</p>
            </a>
          ))}
        </div>
      </div>

      <!-- Prev/Next -->
      <div class="mt-10 pt-8 border-t border-brass/10 grid grid-cols-2 gap-4">
        {prev && (
          <a href={`/research/${prev.slug}`} class="group text-left">
            <div class="font-mono text-[10px] text-chrome-dark/30 uppercase tracking-widest mb-1">Previous</div>
            <div class="font-serif text-sm text-chrome-dark group-hover:text-brass transition-colors">
              <span class="font-mono text-[9px] text-chrome-dark/30 mr-1">{String(prev.number).padStart(2, '0')}</span>
              {prev.title}
            </div>
          </a>
        )}
        {next && (
          <a href={`/research/${next.slug}`} class="group text-right col-start-2">
            <div class="font-mono text-[10px] text-chrome-dark/30 uppercase tracking-widest mb-1">Next</div>
            <div class="font-serif text-sm text-chrome-dark group-hover:text-brass transition-colors">
              <span class="font-mono text-[9px] text-chrome-dark/30 mr-1">{String(next.number).padStart(2, '0')}</span>
              {next.title}
            </div>
          </a>
        )}
      </div>
    </div>

    <!-- Right sidebar: on this page -->
    <aside class="hidden xl:block min-w-0">
      <nav class="research-toc sticky top-24" aria-label="On this page">
        <div class="font-mono text-[10px] font-bold tracking-widest uppercase text-brass/60 mb-3">On this page</div>
        <slot name="toc" />
      </nav>
    </aside>
  </div>
</Base>

<style>
  .research-toc a.active {
    color: var(--color-brass);
  }

  .research-sidebar::-webkit-scrollbar {
    width: 2px;
  }
  .research-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }
  .research-sidebar::-webkit-scrollbar-thumb {
    background: rgba(201, 169, 97, 0.15);
  }
</style>

<script>
  function initResearchToc() {
    const nav = document.querySelector('.research-toc');
    if (!nav) return;
    const links = Array.from(nav.querySelectorAll('a[href^="#"]')) as HTMLAnchorElement[];
    if (links.length === 0) return;

    const headingIds = links
      .map((link) => link.getAttribute('href')?.slice(1))
      .filter(Boolean) as string[];
    const headings = headingIds
      .map((id) => document.getElementById(id))
      .filter((el): el is HTMLElement => el != null);

    if (headings.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (!entry.isIntersecting) continue;
          const id = (entry.target as HTMLElement).id;
          links.forEach((link) => {
            const linkId = link.getAttribute('href')?.slice(1);
            link.classList.toggle('active', linkId === id);
          });
        }
      },
      { rootMargin: '-80px 0px -80% 0px', threshold: 0 }
    );

    headings.forEach((h) => observer.observe(h));

    // Initial active state on load / hash
    function setActiveFromScroll() {
      const offset = 120;
      let bestId: string | null = null;
      let bestTop = -Infinity;
      for (const el of headings) {
        const top = el.getBoundingClientRect().top;
        if (top <= offset && top > bestTop) {
          bestTop = top;
          bestId = el.id;
        }
      }
      if (!bestId && headings.length) bestId = headings[0].id;
      if (bestId) {
        links.forEach((link) => {
          link.classList.toggle('active', link.getAttribute('href')?.slice(1) === bestId);
        });
      }
    }
    setActiveFromScroll();
    if (window.location.hash) {
      requestAnimationFrame(() => requestAnimationFrame(setActiveFromScroll));
      setTimeout(setActiveFromScroll, 100);
      setTimeout(setActiveFromScroll, 300);
      setTimeout(setActiveFromScroll, 600);
    }
    window.addEventListener('scroll', setActiveFromScroll, { passive: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initResearchToc);
  } else {
    initResearchToc();
  }
</script>
