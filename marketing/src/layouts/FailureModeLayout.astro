---
import Base from './Base.astro';
import SEO from '../components/SEO.astro';
import { failureModes, getAdjacentFailureModes } from '../data/research';
import type { FailureMode } from '../data/research';

interface Props {
  failureMode: FailureMode;
}

const { failureMode } = Astro.props;
const { prev, next } = getAdjacentFailureModes(failureMode.slug);
---

<Base title={`${failureMode.title} — When memory breaks — deja`} variant="content">
  <SEO
    slot="head"
    title={`${failureMode.title} — When memory breaks — deja`}
    description={failureMode.description}
    keywords={failureMode.keywords}
    path={`/research/${failureMode.slug}`}
    type="article"
    section="Research"
    tags={failureMode.keywords.split(', ')}
    breadcrumbs={[
      { name: 'Research', path: '/research' },
      { name: 'When memory breaks', path: '/research#when-memory-breaks' },
      { name: failureMode.title, path: `/research/${failureMode.slug}` },
    ]}
  />

  <div class="pt-12 pb-8 xl:grid xl:grid-cols-[minmax(220px,240px)_1fr_minmax(140px,160px)] xl:gap-6 2xl:gap-8">
    <aside class="hidden xl:block min-w-0">
      <nav class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto overflow-x-hidden pr-2 research-sidebar">
        <a href="/research" class="block font-mono text-[10px] font-bold tracking-widest uppercase text-brass mb-4 hover:text-brass-light transition-colors">
          Research
        </a>
        <div class="font-mono text-[9px] font-bold tracking-widest uppercase text-chrome-dark/30 mb-1.5 px-2">
          When memory breaks
        </div>
        {failureModes.map((fm) => (
          <a
            href={`/research/${fm.slug}`}
            class:list={[
              'block py-1.5 px-2 text-[12px] font-serif transition-colors border-l-2 leading-snug',
              fm.slug === failureMode.slug
                ? 'text-brass border-brass bg-brass/5 font-medium'
                : 'text-chrome-dark/50 border-transparent hover:text-chrome hover:border-brass/30',
            ]}
          >
            <span class="font-mono text-[9px] text-chrome-dark/30 mr-1 shrink-0">{fm.number}</span>
            {fm.title}
          </a>
        ))}
      </nav>
    </aside>

    <div class="min-w-0">
      <nav class="font-mono text-[11px] text-chrome-dark/50 mb-6 flex items-center gap-1.5 flex-wrap">
        <a href="/" class="hover:text-brass transition-colors">Home</a><span class="text-chrome-dark/30">/</span>
        <a href="/research" class="hover:text-brass transition-colors">Research</a><span class="text-chrome-dark/30">/</span>
        <a href="/research#when-memory-breaks" class="hover:text-brass transition-colors">When memory breaks</a><span class="text-chrome-dark/30">/</span>
        <span class="text-chrome-dark/70">{failureMode.title}</span>
      </nav>

      <header class="mb-10">
        <span class="font-mono text-[10px] tracking-widest uppercase text-chrome-dark/40 block mb-2">Failure mode</span>
        <h1 class="font-serif-sc text-3xl md:text-4xl font-bold tracking-tight m-0 mb-3">
          {failureMode.title}
        </h1>
        <p class="font-serif text-lg text-chrome-dark m-0 max-w-2xl leading-relaxed">
          {failureMode.tagline}
        </p>
      </header>

      <article class="prose-deja">
        <slot />
      </article>

      <div class="mt-10 pt-8 border-t border-brass/10 grid grid-cols-2 gap-4">
        {prev && (
          <a href={`/research/${prev.slug}`} class="group text-left">
            <div class="font-mono text-[10px] text-chrome-dark/30 uppercase tracking-widest mb-1">Previous</div>
            <div class="font-serif text-sm text-chrome-dark group-hover:text-brass transition-colors">{prev.title}</div>
          </a>
        )}
        {next && (
          <a href={`/research/${next.slug}`} class="group text-right col-start-2">
            <div class="font-mono text-[10px] text-chrome-dark/30 uppercase tracking-widest mb-1">Next</div>
            <div class="font-serif text-sm text-chrome-dark group-hover:text-brass transition-colors">{next.title}</div>
          </a>
        )}
      </div>
    </div>

    <aside class="hidden xl:block min-w-0">
      <nav class="research-toc sticky top-24" aria-label="On this page">
        <div class="font-mono text-[10px] font-bold tracking-widest uppercase text-brass/60 mb-3">On this page</div>
        <slot name="toc" />
      </nav>
    </aside>
  </div>
</Base>

<style>
  .research-sidebar::-webkit-scrollbar {
    width: 2px;
  }
  .research-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }
  .research-sidebar::-webkit-scrollbar-thumb {
    background: rgba(201, 169, 97, 0.15);
  }
  .research-toc a.active {
    color: var(--color-brass);
  }
</style>

<script>
  function initResearchToc() {
    const nav = document.querySelector('.research-toc');
    if (!nav) return;
    const links = Array.from(nav.querySelectorAll('a[href^="#"]')) as HTMLAnchorElement[];
    if (links.length === 0) return;
    const headingIds = links.map((link) => link.getAttribute('href')?.slice(1)).filter(Boolean) as string[];
    const headings = headingIds.map((id) => document.getElementById(id)).filter((el): el is HTMLElement => el != null);
    if (headings.length === 0) return;

    function setActiveFromScroll() {
      const offset = 120;
      let bestId: string | null = null;
      let bestTop = -Infinity;
      for (const el of headings) {
        const top = el.getBoundingClientRect().top;
        if (top <= offset && top > bestTop) {
          bestTop = top;
          bestId = el.id;
        }
      }
      if (!bestId && headings.length) bestId = headings[0].id;
      if (bestId) {
        links.forEach((link) => {
          link.classList.toggle('active', link.getAttribute('href')?.slice(1) === bestId);
        });
      }
    }
    setActiveFromScroll();
    window.addEventListener('scroll', setActiveFromScroll, { passive: true });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initResearchToc);
  } else {
    initResearchToc();
  }
</script>
