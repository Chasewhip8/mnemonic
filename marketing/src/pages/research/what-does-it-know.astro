---
import FailureModeLayout from '../../layouts/FailureModeLayout.astro';
import DoItWithDeja from '../../components/DoItWithDeja.astro';
import { getFailureModeBySlug } from '../../data/research';
const failureMode = getFailureModeBySlug('what-does-it-know')!;
---

<FailureModeLayout failureMode={failureMode}>
  <Fragment slot="toc">
    <a href="#scenario" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Scenario</a>
    <a href="#what-was-needed" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What was needed</a>
    <a href="#minimal-interface" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Minimal interface</a>
    <a href="#do-it-with-deja" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Do it with deja</a>
  </Fragment>

  <h2 id="scenario">Scenario</h2>
  <p>Before trusting the agent in prod, the lead wants to know: what does it believe about deploys? Security? Our stack? Not a raw dump — an audit by topic, with confidence and last-used, so they can spot gaps or overconfidence.</p>

  <h2 id="what-was-needed">What was needed</h2>
  <p>Topic-clustered list of shared (or agent-scoped) learnings. Each topic is a bucket — e.g. "Deployment," "Testing," "Database" — derived from embedding clusters or tags. For each topic: count, average confidence, last recalled if available. Drill into one topic to see the actual triggers and learnings. No heatmap, no timeline — just "what do we know, by theme?"</p>

  <h2 id="minimal-interface">Minimal interface</h2>
  <p>One page: list of topics (labels from k-means on embeddings or manual tags). Each row: topic name, memory count, avg confidence, optional "last used." Click a topic to expand and see the learnings in that bucket. Export or link to filing cabinet for that scope. The minimal version doesn't need time axis or heat — just topics and strength.</p>

  <DoItWithDeja
    blurb="GET /learnings?scope=shared. Group by topic (k-means on embeddings or tag). Show count, avg confidence; expand to list learnings."
    snippets={[
      {
        label: 'List learnings, group by topic',
        code: `const { learnings } = await fetch('/learnings?scope=shared&limit=500').then(r => r.json());
// Group by topic: run k-means on embeddings client-side, or use a tag field if you have it.
// For each topic: name, count, avg confidence, last_recalled_at if present.
// Expand topic → filter learnings in that cluster, show trigger/learning/confidence.`,
      },
    ]}
  />
</FailureModeLayout>
