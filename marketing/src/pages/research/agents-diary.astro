---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import DoItWithDeja from '../../components/DoItWithDeja.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('agents-diary')!;
---

<ResearchLayout concept={concept}>
  <div slot="demo">
    <div class="diary-demo bg-void-deep border border-brass/15 rounded-sm overflow-hidden" id="agent-diary">
      <!-- Agent Header -->
      <div class="diary-header px-6 py-5 border-b border-brass/10">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <div class="font-mono text-[10px] tracking-widest uppercase text-chrome-dark/40 mb-1">Agent Profile</div>
            <h3 class="font-serif text-xl font-semibold m-0 text-chrome">Agent: <span class="text-brass">deploy-bot</span></h3>
          </div>
          <div class="flex items-center gap-5 font-mono text-[11px] text-chrome-dark/60">
            <span><span class="text-chrome font-bold">47</span> learnings</span>
            <span><span class="text-chrome font-bold">12</span> topics</span>
            <span>active since <span class="text-chrome">Jan 2024</span></span>
          </div>
        </div>
        <!-- Belief Coherence -->
        <div class="mt-4 flex items-center gap-3">
          <div class="font-mono text-[10px] tracking-widest uppercase text-chrome-dark/40">Belief Coherence</div>
          <div class="flex-1 max-w-xs h-1.5 bg-steel rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-brass-dark to-brass rounded-full" style="width: 87%"></div>
          </div>
          <div class="font-mono text-[12px]">
            <span class="text-brass font-bold">87%</span>
            <span class="text-chrome-dark/40"> -- </span>
            <span class="text-amber-400/80">2 contradictions detected</span>
          </div>
        </div>
      </div>

      <!-- Topic Cards -->
      <div class="p-6 space-y-3" id="topic-list">
        <!-- Deployment -->
        <div class="topic-card" data-topic="deployment">
          <div class="topic-header cursor-pointer bg-steel/70 border border-brass/10 rounded-sm p-4 hover:border-brass/20 transition-colors">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="font-serif font-semibold text-chrome">Deployment</span>
                <span class="font-mono text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">strong</span>
                <span class="font-mono text-[10px] text-chrome-dark/40">15 learnings</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="challenge-btn font-mono text-[10px] px-2 py-1 rounded-sm border border-chrome-dark/20 text-chrome-dark/50 hover:border-amber-400/40 hover:text-amber-400 transition-colors">Challenge</button>
                <span class="expand-icon font-mono text-[10px] text-chrome-dark/30 transition-transform duration-200">+</span>
              </div>
            </div>
            <div class="confidence-bar h-1 bg-void rounded-full overflow-hidden mb-3">
              <div class="h-full bg-emerald-500/70 rounded-full transition-all duration-500" style="width: 92%"></div>
            </div>
            <p class="font-serif text-[13px] text-chrome-dark/70 m-0 leading-relaxed belief-text">
              This agent strongly believes that production deploys require dry-runs before execution. It has learned through repeated reinforcement that canary deployments reduce blast radius, and that feature flags should gate risky changes. The deployment pipeline is its most confident domain.
            </p>
          </div>
          <div class="topic-learnings hidden bg-void-deep border-x border-b border-brass/10 rounded-b-sm">
            <div class="p-4 space-y-2">
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Always run dry-run before deploying to production"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-emerald-400">0.95</span>
                  <span class="text-chrome-dark/30">recalled 2h ago</span>
                </div>
              </div>
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Canary deploys reduce blast radius significantly"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-emerald-400">0.91</span>
                  <span class="text-chrome-dark/30">recalled 1d ago</span>
                </div>
              </div>
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Use feature flags for risky production changes"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-emerald-400">0.88</span>
                  <span class="text-chrome-dark/30">recalled 3d ago</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Database Migrations -->
        <div class="topic-card" data-topic="migrations">
          <div class="topic-header cursor-pointer bg-steel/70 border border-brass/10 rounded-sm p-4 hover:border-brass/20 transition-colors">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="font-serif font-semibold text-chrome">Database Migrations</span>
                <span class="font-mono text-[10px] px-2 py-0.5 rounded-full bg-amber-400/10 text-amber-400 border border-amber-400/20">moderate</span>
                <span class="font-mono text-[10px] text-chrome-dark/40">8 learnings</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="challenge-btn font-mono text-[10px] px-2 py-1 rounded-sm border border-chrome-dark/20 text-chrome-dark/50 hover:border-amber-400/40 hover:text-amber-400 transition-colors">Challenge</button>
                <span class="expand-icon font-mono text-[10px] text-chrome-dark/30 transition-transform duration-200">+</span>
              </div>
            </div>
            <div class="confidence-bar h-1 bg-void rounded-full overflow-hidden mb-3">
              <div class="h-full bg-amber-400/70 rounded-full transition-all duration-500" style="width: 68%"></div>
            </div>
            <p class="font-serif text-[13px] text-chrome-dark/70 m-0 leading-relaxed belief-text">
              This agent believes that migration state should always be checked before deploying services with database dependencies. It has moderate confidence here -- some runs succeeded without this check, creating ambiguity. It suspects that zero-downtime migrations require more careful sequencing than it currently understands.
            </p>
          </div>
          <div class="topic-learnings hidden bg-void-deep border-x border-b border-brass/10 rounded-b-sm">
            <div class="p-4 space-y-2">
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Check migration state before deploying dependent services"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-amber-400">0.72</span>
                  <span class="text-chrome-dark/30">recalled 5d ago</span>
                </div>
              </div>
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Backward-compatible migrations reduce rollback complexity"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-amber-400">0.65</span>
                  <span class="text-chrome-dark/30">recalled 2w ago</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Monitoring -->
        <div class="topic-card" data-topic="monitoring">
          <div class="topic-header cursor-pointer bg-steel/70 border border-brass/10 rounded-sm p-4 hover:border-brass/20 transition-colors">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="font-serif font-semibold text-chrome">Monitoring</span>
                <span class="font-mono text-[10px] px-2 py-0.5 rounded-full bg-orange-400/10 text-orange-400 border border-orange-400/20">weak</span>
                <span class="font-mono text-[10px] text-chrome-dark/40">3 learnings</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="challenge-btn font-mono text-[10px] px-2 py-1 rounded-sm border border-chrome-dark/20 text-chrome-dark/50 hover:border-amber-400/40 hover:text-amber-400 transition-colors">Challenge</button>
                <span class="expand-icon font-mono text-[10px] text-chrome-dark/30 transition-transform duration-200">+</span>
              </div>
            </div>
            <div class="confidence-bar h-1 bg-void rounded-full overflow-hidden mb-3">
              <div class="h-full bg-orange-400/70 rounded-full transition-all duration-500" style="width: 38%"></div>
            </div>
            <p class="font-serif text-[13px] text-chrome-dark/70 m-0 leading-relaxed belief-text">
              This agent has weak beliefs about monitoring. It knows dashboards should be checked post-deploy, but has little experience with alerting thresholds or anomaly detection. This is a knowledge gap that could matter during incidents.
            </p>
          </div>
          <div class="topic-learnings hidden bg-void-deep border-x border-b border-brass/10 rounded-b-sm">
            <div class="p-4 space-y-2">
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Check monitoring dashboards after every deploy"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-orange-400">0.45</span>
                  <span class="text-chrome-dark/30">recalled 3w ago</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Security -->
        <div class="topic-card" data-topic="security">
          <div class="topic-header cursor-pointer bg-steel/70 border border-brass/10 rounded-sm p-4 hover:border-brass/20 transition-colors">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="font-serif font-semibold text-chrome">Security</span>
                <span class="font-mono text-[10px] px-2 py-0.5 rounded-full bg-red-400/10 text-red-400 border border-red-400/20">uncertain</span>
                <span class="font-mono text-[10px] text-chrome-dark/40">2 learnings</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="challenge-btn font-mono text-[10px] px-2 py-1 rounded-sm border border-chrome-dark/20 text-chrome-dark/50 hover:border-amber-400/40 hover:text-amber-400 transition-colors">Challenge</button>
                <span class="expand-icon font-mono text-[10px] text-chrome-dark/30 transition-transform duration-200">+</span>
              </div>
            </div>
            <div class="confidence-bar h-1 bg-void rounded-full overflow-hidden mb-3">
              <div class="h-full bg-red-400/40 rounded-full transition-all duration-500" style="width: 18%"></div>
            </div>
            <p class="font-serif text-[13px] text-chrome-dark/70 m-0 leading-relaxed belief-text">
              This agent is uncertain about security practices. It has encountered SSL certificate validation and secret rotation but lacks coherent beliefs. Two learnings exist in isolation, unconnected to its deployment knowledge. This is a blind spot.
            </p>
          </div>
          <div class="topic-learnings hidden bg-void-deep border-x border-b border-brass/10 rounded-b-sm">
            <div class="p-4 space-y-2">
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Verify SSL certificates after deploy"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-red-400">0.25</span>
                  <span class="text-chrome-dark/30">never recalled</span>
                </div>
              </div>
              <div class="learning-row flex items-center justify-between py-2 px-3 bg-steel/30 rounded-sm">
                <span class="font-serif text-[12px] text-chrome-dark/80">"Rotate secrets on a schedule"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-red-400">0.18</span>
                  <span class="text-chrome-dark/30">never recalled</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Demo footer -->
      <div class="px-6 py-3 border-t border-brass/10 bg-steel/30">
        <div class="font-mono text-[10px] text-chrome-dark/30 text-center">Interactive demo -- click topics to expand, click Challenge to question a belief</div>
      </div>
    </div>
  </div>

  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#do-it-with-deja" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Do it with deja</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
    <a href="#why-it-matters" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Why it matters</a>
  </Fragment>

  <h2 id="the-experience">The experience</h2>
  <p>
    You open an agent's profile. Not a dashboard of metrics, not a list of runs, not a log stream. A profile. Like opening a colleague's notebook and finding, in their own handwriting, what they believe to be true about the world.
  </p>
  <p>
    The page is organized by topic -- not because anyone manually categorized these memories, but because embedding clusters naturally coalesce around semantic gravity. Deployment knowledge groups together. Database migration wisdom forms its own cluster. Security awareness, thin as it is, sits in a small constellation at the edge.
  </p>
  <p>
    Each topic carries a synthesized narrative. Not bullet points. Not raw data. A paragraph that reads like a belief statement: <em>"This agent strongly believes that production deploys require dry-runs before execution."</em> The language is deliberately anthropomorphic -- not because we think agents have beliefs in the human sense, but because this framing makes the content legible to people who need to understand what the agent will do next.
  </p>
  <p>
    Below each narrative, the individual learnings that compose it. Click to expand, and you see the evidence: each memory with its confidence score and the last time it was recalled. The narrative is the synthesis; the learnings are the evidence. You can verify one against the other.
  </p>
  <p>
    The Challenge button is the most interesting element. Click it, and the belief enters a challenged state -- visually shifting to an uncertain amber. This is not deletion. It is a signal that someone, a human reviewer, has flagged this belief for re-examination. The agent's next run will encounter this challenged state and must either reinforce or revise.
  </p>

  <h2 id="what-it-reveals">What it reveals</h2>
  <p>
    The agent's worldview becomes a coherent document. Or, more revealingly, an incoherent one. The Belief Coherence score at the top is computed by scanning for contradictions across all learnings. When an agent believes "always run dry-run before deploying" but also holds a memory that says "skip dry-runs for hotfixes," the system detects semantic opposition and surfaces it.
  </p>
  <p>
    This is not a theoretical concern. As agents accumulate hundreds or thousands of learnings, contradictions become inevitable. New information conflicts with old. Context-specific advice gets stored without its qualifying context. The diary makes these tensions visible rather than leaving them buried in a vector database where they silently corrupt decision-making.
  </p>
  <p>
    The topic-level confidence indicators reveal the shape of knowledge. A strong Deployment cluster next to a weak Monitoring cluster tells you something actionable: this agent is well-equipped to deploy but poorly equipped to verify the results. That asymmetry is the kind of thing that causes incidents.
  </p>
  <p>
    The temporal dimension matters too. Each learning shows when it was last recalled. A high-confidence belief that hasn't been recalled in weeks might be stale -- the environment may have changed since it was formed. A low-confidence belief that was recalled yesterday might be more practically relevant than its score suggests.
  </p>

  <h2 id="deja-connection">How it connects to deja</h2>
  <p>
    The diary is built from existing deja primitives. The learnings come from <code>/learnings?scope=agent:deploy-bot</code>, which returns every memory associated with this agent. The raw materials are already there.
  </p>
  <p>
    Topic clustering uses the embeddings that deja already stores for every learning. Run a clustering algorithm (k-means, DBSCAN, or hierarchical clustering) over the embedding vectors, and topics emerge without manual labeling. The cluster centroids can be passed to an LLM to generate topic names: "This cluster is mostly about deployment practices."
  </p>
  <p>
    The narrative synthesis is where an LLM does the heavy lifting. Feed it the learnings in a topic cluster, their confidence scores, and their temporal metadata. Ask it to write a belief statement in the first person. The result is surprisingly readable -- and more importantly, auditable. A human can compare the narrative against the source learnings and decide whether the synthesis is faithful.
  </p>
  <p>
    Contradiction detection uses embedding similarity with a twist. Instead of looking for high similarity (memories that reinforce each other), look for high similarity with semantic negation -- memories that occupy the same conceptual space but point in opposite directions. Deja's similarity search already provides the foundation; the contradiction logic is a layer on top.
  </p>
  <p>
    The Challenge mechanism would require a new field on learnings -- something like <code>challenged: boolean</code> or <code>challengedAt: timestamp</code>. When the agent's next <code>/inject</code> call returns challenged memories, the injection layer can add a qualifier: "Note: this memory has been challenged by a human reviewer."
  </p>

  <DoItWithDeja
    blurb="List learnings by scope=agent:AGENT_ID. Group by topic (embedding clusters) or date. Pass to LLM for narrative synthesis."
    snippets={[
      {
        label: 'List agent memories',
        code: `curl -X GET "https://deja.your-subdomain.workers.dev/learnings?scope=agent:deploy-bot" \\
  -H "Authorization: Bearer YOUR_API_KEY"`,
      },
    ]}
  />

  <h2 id="design-tensions">Design tensions</h2>
  <p>
    The deepest tension in the diary is legibility versus accuracy. A natural-language narrative is more readable than a table of embeddings, but it introduces a layer of interpretation. The LLM that writes the narrative might overstate confidence, smooth over nuance, or impose coherence where none exists. The diary must always provide a path from narrative back to raw learnings, so that readers can verify.
  </p>
  <p>
    There is also the question of audience. A developer debugging an agent wants different information than a manager trying to understand whether an agent can be trusted with a production deployment. The diary, by virtue of its natural-language format, serves the latter audience particularly well. This is uncommon in developer tools, which typically optimize for the developer. But as agents become organizational actors -- deploying, responding to incidents, managing infrastructure -- the audience for agent transparency widens.
  </p>
  <p>
    Anthropomorphism is a deliberate choice with real risks. Saying an agent "believes" something is useful shorthand, but it can create false expectations about agent capabilities. The diary should make clear that beliefs are statistical patterns extracted from stored learnings, not convictions held by a thinking entity. The language should serve understanding without encouraging over-attribution.
  </p>
  <p>
    Finally, the Challenge mechanism introduces a governance question. Who is allowed to challenge an agent's beliefs? In a small team, anyone. In an organization with dozens of agents, you may need role-based access to belief modification. The diary becomes not just a transparency tool but a governance surface.
  </p>

  <h2 id="why-it-matters">Why it matters</h2>
  <p>
    As agents become more autonomous, the question shifts from "what did the agent do?" to "what does the agent think?" The run log tells you actions. The diary tells you the cognitive state that produced those actions.
  </p>
  <p>
    Consider an agent that has been running weekly deployments for six months. It has accumulated a rich set of beliefs about your infrastructure. When it makes a decision you disagree with, you need to know whether the problem is a bad memory (wrong information stored), a missing memory (right information never learned), or a contradicted memory (conflicting information producing unpredictable behavior). The diary makes all three cases visible.
  </p>
  <p>
    This is also about trust calibration. The coherence score and the topic-level confidence indicators give you a quantitative basis for deciding how much autonomy to grant. An agent with 95% coherence and strong beliefs in all relevant domains might be safe to run unattended. An agent with 60% coherence and uncertain security knowledge probably needs a human in the loop.
  </p>
  <p>
    The diary is, ultimately, a legibility interface. It makes agent cognition readable by humans. And readability is the precondition for trust, oversight, and meaningful collaboration between humans and autonomous systems.
  </p>
</ResearchLayout>

<style>
  .diary-demo {
    box-shadow:
      0 2px 0 var(--color-void-deep),
      0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .topic-card .topic-header {
    transition: all 0.2s ease;
  }

  .topic-card.expanded .topic-header {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .topic-card .expand-icon {
    display: inline-block;
    transition: transform 0.2s ease;
  }

  .topic-card.expanded .expand-icon {
    transform: rotate(45deg);
  }

  .topic-card.challenged .belief-text {
    color: rgba(251, 191, 36, 0.7);
    font-style: italic;
  }

  .topic-card.challenged .confidence-bar div {
    background: rgba(251, 191, 36, 0.5) !important;
    animation: pulse-uncertain 2s ease-in-out infinite;
  }

  @keyframes pulse-uncertain {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  .learning-row {
    animation: learn-enter 0.2s ease-out backwards;
  }

  .learning-row:nth-child(1) { animation-delay: 0.05s; }
  .learning-row:nth-child(2) { animation-delay: 0.1s; }
  .learning-row:nth-child(3) { animation-delay: 0.15s; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const topicCards = document.querySelectorAll('.topic-card');

    topicCards.forEach(card => {
      const header = card.querySelector('.topic-header');
      const learnings = card.querySelector('.topic-learnings');
      const challengeBtn = card.querySelector('.challenge-btn');

      if (header && learnings) {
        header.addEventListener('click', (e) => {
          if ((e.target as HTMLElement).closest('.challenge-btn')) return;
          const isExpanded = card.classList.contains('expanded');
          if (isExpanded) {
            card.classList.remove('expanded');
            learnings.classList.add('hidden');
          } else {
            card.classList.add('expanded');
            learnings.classList.remove('hidden');
          }
        });
      }

      if (challengeBtn) {
        challengeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isChallenged = card.classList.contains('challenged');
          if (isChallenged) {
            card.classList.remove('challenged');
            challengeBtn.textContent = 'Challenge';
            challengeBtn.classList.remove('!border-amber-400/40', '!text-amber-400');
          } else {
            card.classList.add('challenged');
            challengeBtn.textContent = 'Challenged';
            challengeBtn.classList.add('!border-amber-400/40', '!text-amber-400');
          }
        });
      }
    });
  });
</script>
