---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('before-after-diff')!;
---

<ResearchLayout concept={concept}>
  <div slot="demo">
    <div class="diff-demo bg-void-deep border border-brass/15 rounded-sm overflow-hidden" id="before-after-diff">
      <!-- Diff Header -->
      <div class="px-6 py-4 border-b border-brass/10">
        <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
          <div>
            <div class="font-mono text-[10px] tracking-widest uppercase text-chrome-dark/40 mb-1">Knowledge Diff</div>
            <h3 class="font-serif text-lg font-semibold m-0 text-chrome">
              Run <span class="text-brass">#1847</span>
              <span class="text-chrome-dark/40 font-mono text-[12px]">-- deploy-bot -- auth service deploy</span>
            </h3>
          </div>
          <div class="flex items-center gap-2">
            <button id="toggle-unchanged" class="font-mono text-[10px] px-3 py-1.5 rounded-sm border border-brass/20 text-chrome-dark/50 hover:text-brass hover:border-brass/40 transition-colors">Show unchanged</button>
          </div>
        </div>

        <!-- Summary stats -->
        <div class="flex items-center gap-4 flex-wrap">
          <div class="font-mono text-[12px] text-chrome-dark/60">
            <span class="text-chrome">23</span> learnings before
            <span class="text-chrome-dark/30 mx-1">--></span>
            <span class="text-chrome">25</span> after
          </div>
          <div class="flex items-center gap-3 font-mono text-[10px]">
            <span class="px-2 py-0.5 rounded-sm bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">+3 new</span>
            <span class="px-2 py-0.5 rounded-sm bg-red-400/10 text-red-400 border border-red-400/20">-1 deleted</span>
            <span class="px-2 py-0.5 rounded-sm bg-amber-400/10 text-amber-400 border border-amber-400/20">2 modified</span>
          </div>
        </div>

        <!-- Run impact -->
        <div class="mt-3 px-3 py-2 bg-steel/40 rounded-sm border border-brass/10">
          <div class="font-serif text-[12px] text-chrome-dark/70">
            <span class="text-brass font-semibold">Run impact:</span> This run was productive -- 5 changes across 25 memories. The agent reinforced existing deployment knowledge and acquired two new learnings about post-deploy verification.
          </div>
        </div>
      </div>

      <!-- Diff Content -->
      <div class="diff-body" id="diff-body">
        <!-- New learnings -->
        <div class="diff-entry diff-added cursor-pointer border-b border-brass/5" data-type="added">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-emerald-500/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-emerald-400 font-bold">+</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-emerald-300/90">"always verify SSL certs after deploy"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">confidence:</span>
                  <span class="text-emerald-400">0.60</span>
                  <span class="diff-expand text-chrome-dark/30">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-emerald-500/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-emerald-400/60">source:</span> learned during run #1847</div>
              <div><span class="text-emerald-400/60">scope:</span> agent:deploy-bot</div>
              <div><span class="text-emerald-400/60">embedding cluster:</span> security / post-deploy verification</div>
              <div><span class="text-emerald-400/60">triggered by:</span> SSL validation failure during canary deploy</div>
            </div>
          </div>
        </div>

        <div class="diff-entry diff-added cursor-pointer border-b border-brass/5" data-type="added">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-emerald-500/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-emerald-400 font-bold">+</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-emerald-300/90">"canary deploys reduce risk"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">confidence:</span>
                  <span class="text-emerald-400">0.55</span>
                  <span class="diff-expand text-chrome-dark/30">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-emerald-500/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-emerald-400/60">source:</span> learned during run #1847</div>
              <div><span class="text-emerald-400/60">scope:</span> agent:deploy-bot</div>
              <div><span class="text-emerald-400/60">embedding cluster:</span> deployment / risk management</div>
              <div><span class="text-emerald-400/60">triggered by:</span> successful canary deploy caught config error</div>
            </div>
          </div>
        </div>

        <div class="diff-entry diff-added cursor-pointer border-b border-brass/5" data-type="added">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-emerald-500/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-emerald-400 font-bold">+</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-emerald-300/90">"rollback within 5 minutes of anomaly"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">confidence:</span>
                  <span class="text-emerald-400">0.50</span>
                  <span class="diff-expand text-chrome-dark/30">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-emerald-500/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-emerald-400/60">source:</span> learned during run #1847</div>
              <div><span class="text-emerald-400/60">scope:</span> agent:deploy-bot</div>
              <div><span class="text-emerald-400/60">embedding cluster:</span> deployment / incident response</div>
              <div><span class="text-emerald-400/60">triggered by:</span> observed that delayed rollbacks increase blast radius</div>
            </div>
          </div>
        </div>

        <!-- Deleted learning -->
        <div class="diff-entry diff-deleted cursor-pointer border-b border-brass/5" data-type="deleted">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-red-400/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-red-400 font-bold">-</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-red-300/70 line-through">"skip tests for hotfixes"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">was:</span>
                  <span class="text-red-400">0.22</span>
                  <span class="text-red-400/50 ml-1">contradicted</span>
                  <span class="diff-expand text-chrome-dark/30">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-red-400/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-red-400/60">reason:</span> low confidence + contradiction with "always run dry-run before deploying"</div>
              <div><span class="text-red-400/60">original scope:</span> agent:deploy-bot</div>
              <div><span class="text-red-400/60">age:</span> 47 days, recalled 0 times</div>
              <div><span class="text-red-400/60">contradicts:</span> 2 other learnings in deployment cluster</div>
            </div>
          </div>
        </div>

        <!-- Modified learnings -->
        <div class="diff-entry diff-modified cursor-pointer border-b border-brass/5" data-type="modified">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-amber-400/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-amber-400 font-bold">~</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-amber-200/80">"run dry-run before deploying"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">confidence:</span>
                  <span class="text-chrome-dark/50">0.70</span>
                  <span class="text-emerald-400">--></span>
                  <span class="text-emerald-400">0.80</span>
                  <svg class="inline-block w-3 h-3 text-emerald-400 ml-0.5" viewBox="0 0 12 12" fill="none">
                    <path d="M6 9V3M6 3L3 6M6 3L9 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span class="diff-expand text-chrome-dark/30 ml-1">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-amber-400/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-amber-400/60">change:</span> confidence increased by 0.10</div>
              <div><span class="text-amber-400/60">reason:</span> successfully recalled and applied during this run</div>
              <div><span class="text-amber-400/60">recall count:</span> 7 --> 8</div>
              <div><span class="text-amber-400/60">reinforcement:</span> dry-run caught a config error, validating the practice</div>
            </div>
          </div>
        </div>

        <div class="diff-entry diff-modified cursor-pointer border-b border-brass/5" data-type="modified">
          <div class="diff-entry-header flex items-stretch">
            <div class="diff-gutter w-10 flex-shrink-0 bg-amber-400/5 flex items-center justify-center border-r border-brass/5">
              <span class="font-mono text-[11px] text-amber-400 font-bold">~</span>
            </div>
            <div class="flex-1 px-4 py-3">
              <div class="flex items-center justify-between">
                <span class="font-serif text-[13px] text-amber-200/80">"check migration state"</span>
                <div class="flex items-center gap-3 font-mono text-[10px]">
                  <span class="text-chrome-dark/40">lastRecalled:</span>
                  <span class="text-chrome-dark/50">never</span>
                  <span class="text-amber-400">--></span>
                  <span class="text-amber-400">2024-02-18</span>
                  <span class="diff-expand text-chrome-dark/30 ml-1">+</span>
                </div>
              </div>
            </div>
          </div>
          <div class="diff-detail hidden bg-void px-14 py-3 border-t border-amber-400/10">
            <div class="font-mono text-[10px] text-chrome-dark/50 space-y-1">
              <div><span class="text-amber-400/60">change:</span> first recall of this learning</div>
              <div><span class="text-amber-400/60">reason:</span> migration check was injected as context and used</div>
              <div><span class="text-amber-400/60">confidence:</span> unchanged at 0.72</div>
              <div><span class="text-amber-400/60">note:</span> first recall after 23 days of dormancy</div>
            </div>
          </div>
        </div>

        <!-- Unchanged learnings (hidden by default) -->
        <div id="unchanged-section" class="hidden">
          <div class="diff-entry diff-unchanged border-b border-brass/5" data-type="unchanged">
            <div class="diff-entry-header flex items-stretch">
              <div class="diff-gutter w-10 flex-shrink-0 bg-steel/20 flex items-center justify-center border-r border-brass/5">
                <span class="font-mono text-[11px] text-chrome-dark/20">&nbsp;</span>
              </div>
              <div class="flex-1 px-4 py-2">
                <span class="font-serif text-[12px] text-chrome-dark/25">"use feature flags for risky changes"</span>
                <span class="font-mono text-[10px] text-chrome-dark/15 ml-3">0.71</span>
              </div>
            </div>
          </div>
          <div class="diff-entry diff-unchanged border-b border-brass/5" data-type="unchanged">
            <div class="diff-entry-header flex items-stretch">
              <div class="diff-gutter w-10 flex-shrink-0 bg-steel/20 flex items-center justify-center border-r border-brass/5">
                <span class="font-mono text-[11px] text-chrome-dark/20">&nbsp;</span>
              </div>
              <div class="flex-1 px-4 py-2">
                <span class="font-serif text-[12px] text-chrome-dark/25">"backward-compatible migrations reduce rollback complexity"</span>
                <span class="font-mono text-[10px] text-chrome-dark/15 ml-3">0.65</span>
              </div>
            </div>
          </div>
          <div class="diff-entry diff-unchanged border-b border-brass/5" data-type="unchanged">
            <div class="diff-entry-header flex items-stretch">
              <div class="diff-gutter w-10 flex-shrink-0 bg-steel/20 flex items-center justify-center border-r border-brass/5">
                <span class="font-mono text-[11px] text-chrome-dark/20">&nbsp;</span>
              </div>
              <div class="flex-1 px-4 py-2">
                <span class="font-serif text-[12px] text-chrome-dark/25">"check monitoring dashboards after every deploy"</span>
                <span class="font-mono text-[10px] text-chrome-dark/15 ml-3">0.45</span>
              </div>
            </div>
          </div>
          <div class="diff-entry diff-unchanged border-b border-brass/5" data-type="unchanged">
            <div class="diff-entry-header flex items-stretch">
              <div class="diff-gutter w-10 flex-shrink-0 bg-steel/20 flex items-center justify-center border-r border-brass/5">
                <span class="font-mono text-[11px] text-chrome-dark/20">&nbsp;</span>
              </div>
              <div class="flex-1 px-4 py-2">
                <span class="font-serif text-[12px] text-chrome-dark/25">"verify SSL certificates after deploy"</span>
                <span class="font-mono text-[10px] text-chrome-dark/15 ml-3">0.25</span>
              </div>
            </div>
          </div>
          <div class="unchanged-footer px-4 py-2 bg-steel/10 border-b border-brass/5">
            <span class="font-mono text-[10px] text-chrome-dark/20">... and 15 more unchanged learnings</span>
          </div>
        </div>
      </div>

      <!-- Demo footer -->
      <div class="px-6 py-3 border-t border-brass/10 bg-steel/20">
        <div class="font-mono text-[10px] text-chrome-dark/30 text-center">Interactive demo -- click entries to expand details, toggle unchanged learnings</div>
      </div>
    </div>
  </div>

  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
    <a href="#over-time" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Over time</a>
  </Fragment>

  <h2 id="the-experience">The experience</h2>
  <p>
    You pick a run from the history list. The diff loads. The layout is immediately familiar to anyone who has ever read a git diff or reviewed a pull request: changes on the left gutter, content flowing right, color-coded by operation type. Green for additions. Red for deletions. Amber for modifications. The dimmed rows, if you toggle them on, show what stayed the same.
  </p>
  <p>
    The summary header provides the numbers at a glance. "23 learnings before, 25 after. +3 new, -1 deleted, 2 modified." This is the net impact of a single run on the agent's entire knowledge base. Five changes out of twenty-five is a 20% knowledge delta -- a productive run by any measure.
  </p>
  <p>
    The new learnings appear first, each with a green + prefix. "Always verify SSL certs after deploy." "Canary deploys reduce risk." "Rollback within 5 minutes of anomaly." These are things the agent did not know before this run and now believes to be true. Their initial confidence scores are moderate -- 0.50 to 0.60 -- because they are new observations, not yet reinforced by repetition.
  </p>
  <p>
    The deletion is the most striking entry. "Skip tests for hotfixes" appears in red with a strikethrough. Its confidence had decayed to 0.22, and it contradicted two other learnings in the deployment cluster. The system removed it. This is not data loss -- it is knowledge hygiene. The agent unlearned something wrong.
  </p>
  <p>
    The modifications are subtler. "Run dry-run before deploying" gained a confidence boost from 0.70 to 0.80 -- this run reinforced an existing belief. "Check migration state" had its lastRecalled timestamp updated from "never" to today's date. The learning existed but had never been used until this run pulled it into context. First recall is a meaningful event: a dormant memory becoming active.
  </p>

  <h2 id="what-it-reveals">What it reveals</h2>
  <p>
    The diff reveals the impact of a run on knowledge. This is a fundamentally different question from "what did the run do?" (which is what logs answer) or "what did the run produce?" (which is what outputs answer). The diff asks: <strong>how did the agent change as a result of this experience?</strong>
  </p>
  <p>
    This question matters because agent behavior is cumulative. Each run leaves a residue in the form of modified memories. A run that adds three learnings and deletes one has reshaped the decision surface for every future run. The diff makes that reshaping visible.
  </p>
  <p>
    Consider the deletion. "Skip tests for hotfixes" was a learning that, left unchecked, could have caused the agent to skip tests during a critical hotfix. The contradiction detection caught it. But without the diff, you would never know this correction happened. The learning would simply vanish from the database, and the agent's future behavior would silently improve. The diff gives you observability into the self-correction process.
  </p>
  <p>
    The modification entries reveal reinforcement dynamics. A learning that goes from 0.70 to 0.80 is being strengthened by experience. A learning that gets recalled for the first time is transitioning from theoretical knowledge to practical application. These are signals about knowledge maturation that would be invisible without the diff.
  </p>
  <p>
    The unchanged entries, when toggled visible, provide context. Seeing that 19 out of 25 learnings were untouched tells you that this run's impact was focused. A run that modifies 20 out of 25 learnings would be a different story -- possibly indicating a major context shift or a problematic learning spree.
  </p>

  <h2 id="deja-connection">How it connects to deja</h2>
  <p>
    The diff requires a capability that deja does not currently have: snapshotting the state of an agent's learnings at the start of a run. The <code>state_revisions</code> mechanism already provides versioning for working state, but learnings are mutable objects that change in place. To compute a diff, you need the "before" image.
  </p>
  <p>
    The simplest implementation is a hash-based snapshot. At the start of a run, compute a content hash for each learning associated with the agent's scope. Store these hashes as a run-start manifest. At the end of the run, compute hashes again. New hashes (not in the start manifest) are additions. Missing hashes (in the start manifest but not the end) are deletions. Changed hashes (same learning ID, different hash) are modifications.
  </p>
  <pre><code set:html={`// Run-start snapshot
{
  "run_id": "run_1847_a3f8c",
  "snapshot_at": "2024-02-18T14:23:00Z",
  "learnings": {
    "learn_a1b2": "hash_abc123",
    "learn_c3d4": "hash_def456",
    ...
  }
}`} /></pre>
  <p>
    The hash should cover the fields that matter for diffing: content, confidence, metadata. It should not include fields that change on every read (like lastAccessed), since those would create noise in the diff.
  </p>
  <p>
    An alternative approach is event sourcing. Instead of snapshots, record every mutation to every learning as an event: <code>learning.created</code>, <code>learning.confidence_changed</code>, <code>learning.deleted</code>. The diff is then computed by filtering events that occurred during the run's time window. This is more granular but requires more storage infrastructure.
  </p>
  <p>
    For the initial implementation, the hash-based approach is simpler and sufficient. It adds one write at run-start (the manifest) and one comparison at run-end. The diff itself can be computed client-side given both manifests and the current learning state.
  </p>

  <h2 id="design-tensions">Design tensions</h2>
  <p>
    The most important design decision is what constitutes a "change." Confidence moving from 0.70 to 0.71 is technically a modification, but is it worth showing? The diff needs a sensitivity threshold -- a minimum delta below which changes are treated as noise and excluded. For confidence, a threshold of 0.05 seems reasonable. For timestamps, any change is significant because it represents a recall event.
  </p>
  <p>
    The visual language of git diffs is powerful but imperfect for this use case. Git diffs show line-level changes to text files. Knowledge diffs show property-level changes to structured objects. A learning that changes confidence is not analogous to a line that changed content -- it is more like a variable that changed value. The diff interface borrows the color coding and layout from git but adapts the semantics: instead of added/removed lines, it shows added/removed/modified learnings with their specific deltas.
  </p>
  <p>
    The "Show unchanged" toggle addresses a fundamental tension in information density. Showing only changes makes the diff scannable but hides context. Showing everything makes the diff complete but hard to parse. The toggle lets users choose, defaulting to the focused view. In practice, most users will look at changes only, switching to the full view when they need to understand the broader context of a specific change.
  </p>
  <p>
    There is also a question of attribution. When a learning's confidence increases, is that because it was successfully applied? Because it was recalled and confirmed? Because another learning that contradicted it was deleted? The diff shows the "what" clearly but the "why" is harder. The expandable detail view provides some causal context, but fully explaining why a confidence score changed may require tracing back through the entire run's memory lifecycle -- which is the territory of the Memory Debugger.
  </p>
  <p>
    This points to a natural composition between the two interfaces. The diff shows you the net result; the debugger shows you the process. Together, they provide a complete picture of a run's cognitive impact.
  </p>

  <h2 id="over-time">Over time</h2>
  <p>
    The diff for a single run is useful. But the real power emerges when you look at diffs across many runs. A sequence of diffs tells a story about the agent's learning trajectory.
  </p>
  <p>
    An agent that shows many changes per run early in its life and progressively fewer changes over time is converging. Its knowledge base is stabilizing. It is encountering fewer surprises and reinforcing existing beliefs. This is the expected pattern for a well-functioning agent in a stable environment.
  </p>
  <p>
    An agent that continues to show many changes per run over an extended period is either operating in a volatile environment (which is fine) or failing to converge (which is a problem). If the changes are mostly additions, the environment may genuinely be producing new information. If the changes are oscillating -- the same learning being added, deleted, added, deleted -- the agent has a coherence problem. It is stuck between contradictory observations and cannot resolve them.
  </p>
  <p>
    A convergence score could be computed from diff history: the average number of changes per run over a rolling window, normalized by the total number of learnings. A score approaching zero means stability. A persistently high score means turbulence. This single metric, derived from diffs, tells you something profound about the agent's relationship with its environment.
  </p>
  <p>
    The diff also enables a form of accountability that run logs cannot provide. When a stakeholder asks "what has this agent learned this week?", you can aggregate the diffs from all runs in that period and present a summary: 12 new learnings, 3 deletions, 8 modifications. The knowledge base grew by 15% and the convergence score dropped by 0.3 points. These are the kinds of metrics that make agent operations legible to management -- not as hand-waving about AI capabilities, but as concrete observations about knowledge dynamics.
  </p>
  <p>
    The before/after diff is, at its core, a translation layer. It translates the abstract concept of "an agent learned something" into a concrete, visual, auditable artifact. It takes the invisible process of knowledge accumulation and makes it as readable as a code review. And in doing so, it creates the conditions for meaningful human oversight of agent cognition.
  </p>
</ResearchLayout>

<style>
  .diff-demo {
    box-shadow:
      0 2px 0 var(--color-void-deep),
      0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .diff-entry {
    transition: background-color 0.15s ease;
  }

  .diff-added:hover {
    background-color: rgba(52, 211, 153, 0.03);
  }

  .diff-deleted:hover {
    background-color: rgba(248, 113, 113, 0.03);
  }

  .diff-modified:hover {
    background-color: rgba(251, 191, 36, 0.03);
  }

  .diff-entry .diff-detail {
    animation: detail-enter 0.2s ease-out;
  }

  @keyframes detail-enter {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 200px;
    }
  }

  .diff-unchanged {
    opacity: 0.4;
    transition: opacity 0.15s ease;
  }

  .diff-unchanged:hover {
    opacity: 0.6;
  }

  #unchanged-section {
    animation: unchanged-enter 0.3s ease-out;
  }

  @keyframes unchanged-enter {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Toggle unchanged learnings
    const toggleBtn = document.getElementById('toggle-unchanged');
    const unchangedSection = document.getElementById('unchanged-section');
    let showingUnchanged = false;

    if (toggleBtn && unchangedSection) {
      toggleBtn.addEventListener('click', () => {
        showingUnchanged = !showingUnchanged;
        if (showingUnchanged) {
          unchangedSection.classList.remove('hidden');
          toggleBtn.textContent = 'Hide unchanged';
          toggleBtn.classList.add('!border-brass/40', '!text-brass');
        } else {
          unchangedSection.classList.add('hidden');
          toggleBtn.textContent = 'Show unchanged';
          toggleBtn.classList.remove('!border-brass/40', '!text-brass');
        }
      });
    }

    // Expandable diff entries
    const diffEntries = document.querySelectorAll('.diff-entry[data-type="added"], .diff-entry[data-type="deleted"], .diff-entry[data-type="modified"]');
    diffEntries.forEach(entry => {
      const header = entry.querySelector('.diff-entry-header');
      const detail = entry.querySelector('.diff-detail');
      const expand = entry.querySelector('.diff-expand');

      if (header && detail) {
        header.addEventListener('click', () => {
          const isOpen = !detail.classList.contains('hidden');
          if (isOpen) {
            detail.classList.add('hidden');
            if (expand) expand.textContent = '+';
          } else {
            detail.classList.remove('hidden');
            if (expand) expand.textContent = '-';
          }
        });
      }
    });
  });
</script>
