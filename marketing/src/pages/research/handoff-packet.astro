---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import DoItWithDeja from '../../components/DoItWithDeja.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('handoff-packet')!;
---

<ResearchLayout concept={concept}>
  <div slot="demo">
    <div class="handoff-container border border-brass/20 rounded-sm bg-void-deep overflow-hidden">
      <!-- Packet Header -->
      <div class="px-6 py-4 border-b border-brass/10 bg-steel/30">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full bg-brass animate-pulse"></span>
            <span class="font-mono text-[10px] font-bold tracking-widest uppercase text-brass">Handoff Packet</span>
          </div>
          <span class="font-mono text-[10px] text-chrome-dark/30">run:deploy-2024-0218-14a3</span>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-brass/20 text-brass font-mono text-[9px] font-bold">DB</span>
            <span class="font-serif text-sm text-chrome">deploy-bot</span>
          </div>
          <svg class="w-4 h-4 text-brass/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-blue-500/20 text-blue-400 font-mono text-[9px] font-bold">FI</span>
            <span class="font-serif text-sm text-chrome">fix-it-agent</span>
          </div>
        </div>
        <div class="font-mono text-[10px] text-chrome-dark/30 mt-2">2024-02-18 14:32:07 UTC</div>
      </div>

      <!-- Packet Sections -->
      <div class="packet-body" id="packet-body">
        <!-- Section 1: Mission Summary -->
        <div class="packet-section" data-section="mission">
          <button class="section-header" data-toggle="mission">
            <span class="section-number">01</span>
            <span class="section-title">Mission Summary</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content expanded" id="content-mission">
            <p class="packet-text">
              Deployed auth-service v2.4.1 to staging environment. Deployment completed successfully but post-deploy verification revealed 3 test failures in the integration suite. Two failures have known causes; one is unexplained.
            </p>
            <div class="packet-status">
              <span class="status-tag warning">3 test failures</span>
              <span class="status-tag success">deploy succeeded</span>
              <span class="status-tag neutral">needs follow-up</span>
            </div>
          </div>
        </div>

        <!-- Section 2: What was accomplished -->
        <div class="packet-section" data-section="accomplished">
          <button class="section-header" data-toggle="accomplished">
            <span class="section-number">02</span>
            <span class="section-title">What was accomplished</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-accomplished">
            <ul class="packet-list">
              <li class="done">Pulled auth-service v2.4.1 from registry</li>
              <li class="done">Ran database migration #47 (schema update for session tokens)</li>
              <li class="done">Deployed to staging-01 and staging-02</li>
              <li class="done">Health checks passed on both instances</li>
              <li class="done">Ran smoke tests (5/5 passed)</li>
              <li class="partial">Ran integration suite (42/45 passed, 3 failures)</li>
              <li class="skipped">Production deploy -- blocked by test failures</li>
            </ul>
          </div>
        </div>

        <!-- Section 3: What was learned -->
        <div class="packet-section" data-section="learned">
          <button class="section-header" data-toggle="learned">
            <span class="section-number">03</span>
            <span class="section-title">What was learned</span>
            <span class="section-badge">3 new</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-learned">
            <div class="learning-item">
              <div class="learning-header">
                <span class="font-mono text-[9px] text-brass/50">LEARNED</span>
                <span class="confidence-badge high">0.88</span>
              </div>
              <p class="packet-text">Migration #47 requires the auth-service to be restarted after schema update, not just reloaded. Hot-reload misses the new session_tokens table.</p>
            </div>
            <div class="learning-item">
              <div class="learning-header">
                <span class="font-mono text-[9px] text-brass/50">LEARNED</span>
                <span class="confidence-badge medium">0.72</span>
              </div>
              <p class="packet-text">Staging-02 has a port conflict on 8080 that does not exist on staging-01. The monitoring dashboard occupies the port intermittently.</p>
            </div>
            <div class="learning-item">
              <div class="learning-header">
                <span class="font-mono text-[9px] text-brass/50">LEARNED</span>
                <span class="confidence-badge low">0.45</span>
              </div>
              <p class="packet-text">Test failure in auth/token-refresh may be related to clock skew between staging instances. Uncertain -- could also be a race condition in the test itself.</p>
            </div>
          </div>
        </div>

        <!-- Section 4: Known Issues -->
        <div class="packet-section" data-section="issues">
          <button class="section-header" data-toggle="issues">
            <span class="section-number">04</span>
            <span class="section-title">Known Issues</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-issues">
            <div class="issue-item explained">
              <div class="issue-label">EXPLAINED</div>
              <p class="packet-text"><strong>auth/login-flow:</strong> Fails because migration #47 requires full restart. Fixed by restarting auth-service on staging-01.</p>
            </div>
            <div class="issue-item explained">
              <div class="issue-label">EXPLAINED</div>
              <p class="packet-text"><strong>auth/session-persist:</strong> Port conflict on staging-02 prevents the session store from binding. Workaround: use port 8081.</p>
            </div>
            <div class="issue-item unknown">
              <div class="issue-label unknown">UNKNOWN</div>
              <p class="packet-text"><strong>auth/token-refresh:</strong> Intermittent failure. Passed on retry 2 of 3. May be clock skew or race condition. Needs investigation.</p>
            </div>
          </div>
        </div>

        <!-- Section 5: Open Questions -->
        <div class="packet-section" data-section="questions">
          <button class="section-header" data-toggle="questions">
            <span class="section-number">05</span>
            <span class="section-title">Open Questions</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-questions">
            <div class="question-item">
              <span class="question-pulse"></span>
              <p class="packet-text">Is the port conflict on staging-02 related to the monitoring dashboard update last week, or is it a longer-standing issue?</p>
            </div>
            <div class="question-item">
              <span class="question-pulse"></span>
              <p class="packet-text">Should token-refresh tests be marked as flaky, or is there a real bug hiding behind the intermittent failure?</p>
            </div>
          </div>
        </div>

        <!-- Section 6: Recommended Next Actions -->
        <div class="packet-section" data-section="actions">
          <button class="section-header" data-toggle="actions">
            <span class="section-number">06</span>
            <span class="section-title">Recommended Next Actions</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-actions">
            <ol class="action-list">
              <li><strong>Investigate</strong> the unknown test failure in auth/token-refresh -- run in isolation with verbose logging</li>
              <li><strong>Verify</strong> port availability on staging-02 and confirm whether 8081 is a safe alternative</li>
              <li><strong>Re-run</strong> the full integration suite after addressing known issues</li>
              <li><strong>Clear</strong> the deploy to production if all 45 tests pass</li>
            </ol>
          </div>
        </div>

        <!-- Section 7: Relevant Shared Memories -->
        <div class="packet-section" data-section="memories">
          <button class="section-header" data-toggle="memories">
            <span class="section-number">07</span>
            <span class="section-title">Relevant Shared Memories</span>
            <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div class="section-content" id="content-memories">
            <div class="shared-memory">
              <div class="memory-source">shared scope -- similarity: 0.91</div>
              <p class="packet-text">"Staging-02 has intermittent port conflicts on 8080. The monitoring dashboard binds to it during health check sweeps."</p>
              <div class="memory-meta">Contributed by monitor-bot -- recalled 7 times -- 4 endorsements</div>
            </div>
            <div class="shared-memory">
              <div class="memory-source">shared scope -- similarity: 0.84</div>
              <p class="packet-text">"Clock skew between staging instances can cause token validation failures. NTP sync runs every 6 hours, not continuously."</p>
              <div class="memory-meta">Contributed by human:alice -- recalled 3 times -- 2 endorsements</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Receive Handoff -->
      <div class="px-6 py-4 border-t border-brass/10 bg-steel/20">
        <div id="handoff-controls">
          <button id="receive-handoff-btn" class="receive-btn">
            Receive Handoff
          </button>
        </div>
        <div id="handoff-progress" class="hidden">
          <div class="flex items-center justify-between mb-2">
            <span class="font-mono text-[10px] text-brass">Loading handoff into fix-it-agent context...</span>
            <span class="font-mono text-[10px] text-brass" id="progress-pct">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="font-mono text-[10px] text-chrome-dark/30 mt-2" id="progress-status">Parsing mission summary...</div>
        </div>
        <div id="handoff-complete" class="hidden">
          <div class="flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
            <span class="font-mono text-[10px] text-emerald-400">Handoff complete. fix-it-agent has full context.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#do-it-with-deja" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Do it with deja</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
  </Fragment>

  <h2 id="the-experience">The experience</h2>

  <p>
    Agent A finishes its work. Maybe it deployed a service, ran a test suite, or investigated a production incident. Before it shuts down, the system generates a handoff packet -- a structured briefing document that captures everything the next agent needs to continue the work. The packet is not a log dump. It is a curated, scannable summary organized around what matters: what was accomplished, what was learned, what is still uncertain, and what should happen next.
  </p>
  <p>
    The receiving agent -- Agent B -- does not start from zero. It opens the packet and reads a professional briefing, not unlike what a new team member might receive from a colleague leaving for vacation. The mission summary gives immediate orientation. The accomplished section provides context without requiring Agent B to replay the entire run. The learned section transfers new knowledge directly into Agent B's working memory, including confidence scores that signal how much trust to place in each insight.
  </p>
  <p>
    The known issues section is where real value appears. When a deployment agent finds three test failures, the natural output is a log file with stack traces. The handoff packet transforms that into structured intelligence: two failures are explained with root causes and workarounds, one is flagged as unknown with preliminary hypotheses. The receiving agent knows exactly what is solved and what needs investigation.
  </p>
  <p>
    Open questions pulse at the bottom of the packet -- literally, in the demo above. These are the things the sending agent noticed but could not resolve. They are invitations for the next agent to investigate. And critically, the packet includes relevant shared memories: learnings from the collective knowledge base that might help the receiving agent solve what the sending agent could not. The packet is not just a transfer of local knowledge; it connects the recipient to the broader organizational memory.
  </p>

  <h2 id="what-it-reveals">What it reveals</h2>

  <p>
    The handoff packet reveals the single biggest problem in multi-agent workflows: context loss at boundaries. When one agent finishes and another starts, knowledge evaporates. The new agent has access to the same tools and the same codebase, but it lacks the narrative -- the story of what happened, why certain decisions were made, and what the tricky parts were. This is exactly the same problem that plagues human teams during shift changes, project handoffs, and employee transitions.
  </p>
  <p>
    In human organizations, we solve this with documentation, meetings, and overlap periods. None of these translate cleanly to agent systems. Agents do not have water-cooler conversations. They do not overhear context. They start each run with exactly the information they are given, nothing more. This makes explicit handoff mechanisms not just useful but essential.
  </p>
  <p>
    The packet also reveals the difference between data and intelligence. A raw log of what Agent A did is data. A structured briefing that categorizes accomplishments, extracts learnings, identifies uncertainties, and recommends next steps is intelligence. The transformation from one to the other is itself an act of cognition -- it requires judgment about what matters, what is uncertain, and what the receiving agent needs to know.
  </p>
  <p>
    Perhaps most interestingly, the handoff packet reveals what agents are uncertain about. The "open questions" section is a window into the limits of the sending agent's understanding. This is valuable not just for the receiving agent but for the humans overseeing the system. When an agent says "I do not know whether this port conflict is related to last week's update," it is surfacing the boundary of its knowledge in a way that raw logs never would.
  </p>

  <h2 id="deja-connection">How it connects to deja</h2>

  <p>
    Deja's <code>state_resolve</code> mechanism already performs half of what the handoff packet requires. When an agent calls <code>state_resolve</code>, it receives relevant memories from its scope -- effectively loading prior context. The <code>persistToLearn</code> parameter already converts run outcomes into stored learnings. What is missing is the structured packaging of this information for a specific recipient.
  </p>
  <p>
    The technical implementation would center on a new <code>/handoff/:runId</code> endpoint. When a run completes, the system generates a packet by combining several data sources: the run's action log (what was done), any learnings created during the run (what was learned), the run's final state (what succeeded and what failed), and relevant shared memories matched by similarity to the run's context. The packet itself would be a structured JSON document that can be rendered as a UI (as shown in the demo) or consumed programmatically by the next agent.
  </p>
  <p>
    The receiving side would use a new <code>POST /handoff/:runId/receive</code> endpoint that loads the packet's learnings into the receiving agent's context, marks open questions as active investigation targets, and creates a link between the two runs for auditability. The receiving agent's first <code>state_resolve</code> call would then include handoff context alongside normal memory retrieval.
  </p>
  <p>
    The harder engineering question is packet generation. Summarizing a run into a clean briefing is itself an LLM task -- the system needs to distinguish between significant actions and noise, categorize failures, and extract the narrative from raw event data. This is an area where deja's learning extraction pipeline could be extended: instead of just generating <code>trigger/learning</code> pairs, generate a structured mission report.
  </p>

  <DoItWithDeja
    blurb="On run end: GET state + list learnings for run. Serialize to handoff JSON. POST to queue or next agent."
    snippets={[
      {
        label: 'Build handoff packet',
        code: `const state = await fetch('/state?run_id=' + runId).then(r => r.json());
const learnings = await fetch('/learnings?scope=agent:' + agentId).then(r => r.json());
const packet = { goal: state.goal, learnings: learnings.learnings, open_questions: state.open_questions };
await fetch('/queue/handoff', { method: 'POST', body: JSON.stringify(packet) });`,
      },
    ]}
  />

  <h2 id="design-tensions">Design tensions</h2>

  <p>
    <strong>The concrete example that motivates everything.</strong> A CI agent detects three test failures after a staging deploy. It has enough context to explain two of them -- one is a known migration issue, the other is a recurring port conflict. The third is a mystery. The CI agent's run ends. A fix-it agent starts. Without a handoff, the fix-it agent investigates all three failures from scratch, potentially wasting time re-discovering what the CI agent already knew. With a handoff, the fix-it agent skips the two known issues and focuses immediately on the unknown failure. This is not a theoretical improvement. It is the difference between a 20-minute resolution and an hour-long re-investigation.
  </p>
  <p>
    <strong>Packet fidelity vs. packet size.</strong> A complete handoff packet could include every log line, every API response, every intermediate state. But the receiving agent does not need all of that -- it needs a summary. Summarization inevitably loses information. The design tension is between completeness (include everything, let the receiver filter) and usability (curate aggressively, risk losing something important). The right answer is probably layered: a concise summary at the top with expandable detail underneath, as shown in the demo.
  </p>
  <p>
    <strong>Trust propagation.</strong> When Agent B receives a handoff packet from Agent A, it inherits Agent A's conclusions. If Agent A incorrectly categorizes a failure as "explained," Agent B may skip investigating it. The handoff packet creates a trust chain: the receiving agent trusts the sending agent's analysis. This is fine when agents are reliable, but it creates a single point of failure when they are not. Confidence scores help -- a learning marked at 0.45 confidence is clearly uncertain -- but they do not eliminate the risk.
  </p>
  <p>
    <strong>The human in the loop.</strong> Should humans review handoff packets before they are consumed? In high-stakes environments (production deployments, security incidents), the answer is probably yes. In routine operations (daily CI runs, standard test suites), human review would be a bottleneck. The system needs configurable gates: auto-approve routine handoffs, require human review for handoffs involving failures, security changes, or low-confidence learnings.
  </p>
  <p>
    The handoff packet is ultimately a document of institutional continuity. It ensures that when one worker leaves and another arrives, the new arrival is not starting from zero. In human organizations, this kind of continuity is fragile and expensive. In agent systems, it can be systematic and cheap -- if we build the right abstractions. Deja is already halfway there. The packet is the missing bridge.
  </p>
</ResearchLayout>

<style>
  .handoff-container {
    box-shadow:
      inset 0 1px 0 rgba(201, 169, 97, 0.05),
      0 4px 24px rgba(0, 0, 0, 0.5);
  }

  .packet-section {
    border-bottom: 1px solid rgba(201, 169, 97, 0.06);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 12px 24px;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    text-align: left;
  }

  .section-header:hover {
    background: rgba(201, 169, 97, 0.03);
  }

  .section-number {
    font-family: var(--font-family-mono);
    font-size: 10px;
    font-weight: 700;
    color: rgba(201, 169, 97, 0.3);
    min-width: 20px;
  }

  .section-title {
    font-family: var(--font-family-serif);
    font-size: 14px;
    font-weight: 600;
    color: #e8e8e8;
    flex: 1;
  }

  .section-badge {
    font-family: var(--font-family-mono);
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 2px;
    background: rgba(201, 169, 97, 0.1);
    color: #c9a961;
  }

  .chevron {
    width: 16px;
    height: 16px;
    color: rgba(184, 184, 184, 0.2);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .section-header.open .chevron {
    transform: rotate(180deg);
  }

  .section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s;
    padding: 0 24px;
  }

  .section-content.expanded {
    max-height: 600px;
    padding: 0 24px 16px 54px;
  }

  .packet-text {
    font-family: var(--font-family-serif);
    font-size: 13px;
    color: #b8b8b8;
    line-height: 1.6;
    margin: 0 0 8px;
  }

  .packet-text strong {
    color: #e8e8e8;
  }

  .status-tag {
    display: inline-block;
    font-family: var(--font-family-mono);
    font-size: 9px;
    padding: 2px 8px;
    border-radius: 2px;
    margin-right: 4px;
  }

  .status-tag.success {
    background: rgba(52, 211, 153, 0.1);
    color: #34d399;
    border: 1px solid rgba(52, 211, 153, 0.2);
  }

  .status-tag.warning {
    background: rgba(234, 179, 8, 0.1);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.2);
  }

  .status-tag.neutral {
    background: rgba(184, 184, 184, 0.05);
    color: rgba(184, 184, 184, 0.5);
    border: 1px solid rgba(184, 184, 184, 0.1);
  }

  .packet-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .packet-list li {
    font-family: var(--font-family-serif);
    font-size: 13px;
    color: #b8b8b8;
    padding: 4px 0 4px 20px;
    position: relative;
    line-height: 1.5;
  }

  .packet-list li::before {
    position: absolute;
    left: 0;
    font-family: var(--font-family-mono);
    font-size: 11px;
  }

  .packet-list li.done::before {
    content: "+";
    color: #34d399;
  }

  .packet-list li.partial::before {
    content: "~";
    color: #eab308;
  }

  .packet-list li.skipped::before {
    content: "-";
    color: rgba(184, 184, 184, 0.3);
  }

  .packet-list li.skipped {
    color: rgba(184, 184, 184, 0.3);
  }

  .learning-item {
    padding: 10px;
    border: 1px solid rgba(201, 169, 97, 0.08);
    border-radius: 2px;
    margin-bottom: 8px;
    background: rgba(201, 169, 97, 0.02);
  }

  .learning-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .confidence-badge {
    font-family: var(--font-family-mono);
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 2px;
  }

  .confidence-badge.high {
    background: rgba(52, 211, 153, 0.1);
    color: #34d399;
  }

  .confidence-badge.medium {
    background: rgba(234, 179, 8, 0.1);
    color: #eab308;
  }

  .confidence-badge.low {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .issue-item {
    padding: 10px;
    border-radius: 2px;
    margin-bottom: 8px;
  }

  .issue-item.explained {
    border-left: 3px solid #34d399;
    background: rgba(52, 211, 153, 0.03);
    padding-left: 12px;
  }

  .issue-item.unknown {
    border-left: 3px solid #ef4444;
    background: rgba(239, 68, 68, 0.03);
    padding-left: 12px;
  }

  .issue-label {
    font-family: var(--font-family-mono);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: #34d399;
    margin-bottom: 4px;
  }

  .issue-label.unknown {
    color: #ef4444;
  }

  .question-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px;
    border: 1px solid rgba(201, 169, 97, 0.1);
    border-radius: 2px;
    margin-bottom: 8px;
  }

  .question-pulse {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #c9a961;
    flex-shrink: 0;
    margin-top: 4px;
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { opacity: 0.4; box-shadow: 0 0 0 0 rgba(201, 169, 97, 0.3); }
    50% { opacity: 1; box-shadow: 0 0 8px 2px rgba(201, 169, 97, 0.2); }
  }

  .action-list {
    padding-left: 20px;
    margin: 0;
  }

  .action-list li {
    font-family: var(--font-family-serif);
    font-size: 13px;
    color: #b8b8b8;
    padding: 4px 0;
    line-height: 1.5;
  }

  .action-list li strong {
    color: #c9a961;
  }

  .shared-memory {
    padding: 10px;
    border: 1px solid rgba(201, 169, 97, 0.1);
    border-radius: 2px;
    margin-bottom: 8px;
    background: rgba(201, 169, 97, 0.02);
  }

  .memory-source {
    font-family: var(--font-family-mono);
    font-size: 9px;
    color: rgba(201, 169, 97, 0.4);
    margin-bottom: 4px;
  }

  .memory-meta {
    font-family: var(--font-family-mono);
    font-size: 9px;
    color: rgba(184, 184, 184, 0.3);
    margin-top: 4px;
  }

  .receive-btn {
    font-family: var(--font-family-mono);
    font-size: 12px;
    font-weight: 700;
    padding: 8px 20px;
    border-radius: 2px;
    border: 1px solid rgba(201, 169, 97, 0.3);
    background: rgba(201, 169, 97, 0.1);
    color: #c9a961;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .receive-btn:hover {
    background: rgba(201, 169, 97, 0.2);
    border-color: rgba(201, 169, 97, 0.5);
  }

  .progress-bar {
    height: 4px;
    background: rgba(201, 169, 97, 0.1);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #c9a961, #d4bc87);
    border-radius: 2px;
    transition: width 0.3s ease-out;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  // Expand/collapse sections
  document.querySelectorAll('.section-header').forEach(header => {
    const sectionName = (header as HTMLElement).dataset.toggle;
    const content = document.getElementById(`content-${sectionName}`);
    if (!content) return;

    // Start with first section expanded
    if (sectionName === 'mission') {
      header.classList.add('open');
    }

    header.addEventListener('click', () => {
      const isOpen = content.classList.contains('expanded');
      if (isOpen) {
        content.classList.remove('expanded');
        header.classList.remove('open');
      } else {
        content.classList.add('expanded');
        header.classList.add('open');
      }
    });
  });

  // Receive handoff animation
  const receiveBtn = document.getElementById('receive-handoff-btn');
  const controls = document.getElementById('handoff-controls');
  const progress = document.getElementById('handoff-progress');
  const complete = document.getElementById('handoff-complete');
  const progressFill = document.getElementById('progress-fill');
  const progressPct = document.getElementById('progress-pct');
  const progressStatus = document.getElementById('progress-status');

  const stages = [
    { pct: 15, status: 'Parsing mission summary...' },
    { pct: 30, status: 'Loading accomplished actions...' },
    { pct: 50, status: 'Ingesting 3 new learnings...' },
    { pct: 65, status: 'Cataloging known issues...' },
    { pct: 75, status: 'Registering open questions...' },
    { pct: 85, status: 'Loading recommended actions...' },
    { pct: 95, status: 'Matching shared memories...' },
    { pct: 100, status: 'Handoff complete.' },
  ];

  receiveBtn?.addEventListener('click', () => {
    if (controls) controls.classList.add('hidden');
    if (progress) progress.classList.remove('hidden');

    let i = 0;
    const step = () => {
      if (i >= stages.length) {
        setTimeout(() => {
          if (progress) progress.classList.add('hidden');
          if (complete) complete.classList.remove('hidden');
        }, 500);
        return;
      }
      const s = stages[i];
      if (progressFill) progressFill.style.width = s.pct + '%';
      if (progressPct) progressPct.textContent = s.pct + '%';
      if (progressStatus) progressStatus.textContent = s.status;
      i++;
      setTimeout(step, 400 + Math.random() * 200);
    };
    step();
  });
</script>
