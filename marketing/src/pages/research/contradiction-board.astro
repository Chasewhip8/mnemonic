---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('contradiction-board')!;
---

<ResearchLayout concept={concept}>
  <!-- Demo -->
  <div slot="demo">
    <div class="cb-demo bg-void-deep border border-brass/15 rounded-sm overflow-hidden">
      <!-- Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-brass/10 bg-steel/50">
        <div class="flex items-center gap-3">
          <span class="font-mono text-[10px] font-bold tracking-widest uppercase text-brass/70">Contradiction Board</span>
          <span class="font-mono text-[9px] text-chrome-dark/30 border-l border-brass/10 pl-3">Detected via cosine similarity &gt; 0.85 + LLM contradiction classification</span>
        </div>
        <div id="cb-stats" class="font-mono text-[10px] text-chrome-dark/40">3 contradictions found across 47 shared memories. 0 resolved.</div>
      </div>

      <!-- Contradiction pairs -->
      <div class="p-4 space-y-4" id="cb-pairs">
        <!-- Pair 1: High priority -->
        <div class="cb-pair" data-pair="0" data-resolved="false">
          <div class="cb-pair-header flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="cb-priority-badge high font-mono text-[9px] font-bold tracking-widest uppercase px-2 py-0.5 rounded-sm">High</span>
              <span class="font-mono text-[10px] text-chrome-dark/50">Similarity: 0.89</span>
              <span class="font-serif text-[11px] text-chrome-dark/40 italic ml-1">High semantic overlap with opposing conclusions</span>
            </div>
          </div>
          <div class="cb-conflict-container grid grid-cols-2 gap-3">
            <!-- Left memory -->
            <div class="cb-memory-card left bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory A</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.85</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Always use feature flags for new deployments"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by deploy-bot</span>
                <span>recalled 8 times</span>
              </div>
            </div>
            <!-- Right memory -->
            <div class="cb-memory-card right bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory B</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.70</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Feature flags add unnecessary complexity to deploys"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by fix-it-bot</span>
                <span>recalled 3 times</span>
              </div>
            </div>
          </div>
          <!-- Resolution buttons -->
          <div class="cb-actions flex items-center gap-2 mt-3">
            <button class="cb-action-btn merge font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="merge" data-pair="0">Merge</button>
            <button class="cb-action-btn keep-left font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-left" data-pair="0">Keep Left</button>
            <button class="cb-action-btn keep-right font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-right" data-pair="0">Keep Right</button>
            <button class="cb-action-btn both-valid font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="both-valid" data-pair="0">Both Valid</button>
          </div>
          <!-- Resolved state (hidden initially) -->
          <div class="cb-resolved-card hidden bg-steel/40 border-2 border-green-700/40 rounded-sm p-3 mt-2">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-mono text-[9px] font-bold tracking-widest uppercase text-green-500/70">Resolved</span>
              <span class="cb-resolution-method font-mono text-[9px] text-chrome-dark/40"></span>
            </div>
            <p class="cb-resolved-text font-serif text-[13px] text-chrome/80 leading-relaxed m-0"></p>
          </div>
        </div>

        <!-- Pair 2: Medium priority -->
        <div class="cb-pair" data-pair="1" data-resolved="false">
          <div class="cb-pair-header flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="cb-priority-badge medium font-mono text-[9px] font-bold tracking-widest uppercase px-2 py-0.5 rounded-sm">Medium</span>
              <span class="font-mono text-[10px] text-chrome-dark/50">Similarity: 0.82</span>
            </div>
          </div>
          <div class="cb-conflict-container grid grid-cols-2 gap-3">
            <div class="cb-memory-card left bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory A</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.90</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Run full test suite before deploying"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by ci-bot</span>
                <span>recalled 12 times</span>
              </div>
            </div>
            <div class="cb-memory-card right bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory B</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.50</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Skip integration tests for hotfixes to save time"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by hotfix-bot</span>
                <span>recalled 2 times</span>
              </div>
            </div>
          </div>
          <div class="cb-actions flex items-center gap-2 mt-3">
            <button class="cb-action-btn merge font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="merge" data-pair="1">Merge</button>
            <button class="cb-action-btn keep-left font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-left" data-pair="1">Keep Left</button>
            <button class="cb-action-btn keep-right font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-right" data-pair="1">Keep Right</button>
            <button class="cb-action-btn both-valid font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="both-valid" data-pair="1">Both Valid</button>
          </div>
          <div class="cb-resolved-card hidden bg-steel/40 border-2 border-green-700/40 rounded-sm p-3 mt-2">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-mono text-[9px] font-bold tracking-widest uppercase text-green-500/70">Resolved</span>
              <span class="cb-resolution-method font-mono text-[9px] text-chrome-dark/40"></span>
            </div>
            <p class="cb-resolved-text font-serif text-[13px] text-chrome/80 leading-relaxed m-0"></p>
          </div>
        </div>

        <!-- Pair 3: Low priority -->
        <div class="cb-pair" data-pair="2" data-resolved="false">
          <div class="cb-pair-header flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="cb-priority-badge low font-mono text-[9px] font-bold tracking-widest uppercase px-2 py-0.5 rounded-sm">Low</span>
              <span class="font-mono text-[10px] text-chrome-dark/50">Similarity: 0.78</span>
              <span class="font-serif text-[11px] text-chrome-dark/40 italic ml-1">Context-dependent, not truly contradictory</span>
            </div>
          </div>
          <div class="cb-conflict-container grid grid-cols-2 gap-3">
            <div class="cb-memory-card left bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory A</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.95</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Always use HTTPS for external APIs"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by security-bot</span>
                <span>recalled 15 times</span>
              </div>
            </div>
            <div class="cb-memory-card right bg-steel/60 border border-brass/10 rounded-sm p-3">
              <div class="flex items-center justify-between mb-2">
                <span class="font-mono text-[9px] text-chrome-dark/30 uppercase tracking-wider">Memory B</span>
                <span class="font-mono text-[9px] text-brass/50">conf: 0.80</span>
              </div>
              <p class="font-serif text-[13px] text-chrome/80 leading-relaxed m-0 mb-2">"Use HTTP for internal service mesh"</p>
              <div class="flex items-center gap-3 text-[9px] font-mono text-chrome-dark/30">
                <span>by infra-bot</span>
                <span>recalled 6 times</span>
              </div>
            </div>
          </div>
          <div class="cb-actions flex items-center gap-2 mt-3">
            <button class="cb-action-btn merge font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="merge" data-pair="2">Merge</button>
            <button class="cb-action-btn keep-left font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-left" data-pair="2">Keep Left</button>
            <button class="cb-action-btn keep-right font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="keep-right" data-pair="2">Keep Right</button>
            <button class="cb-action-btn both-valid font-mono text-[10px] tracking-wider px-3 py-1.5 rounded-sm border transition-all" data-action="both-valid" data-pair="2">Both Valid</button>
          </div>
          <div class="cb-resolved-card hidden bg-steel/40 border-2 border-green-700/40 rounded-sm p-3 mt-2">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-mono text-[9px] font-bold tracking-widest uppercase text-green-500/70">Resolved</span>
              <span class="cb-resolution-method font-mono text-[9px] text-chrome-dark/40"></span>
            </div>
            <p class="cb-resolved-text font-serif text-[13px] text-chrome/80 leading-relaxed m-0"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ToC -->
  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
    <a href="#why-uniquely-important" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Why uniquely important</a>
  </Fragment>

  <!-- Content -->
  <h2 id="the-experience">The experience</h2>

  <p>You open the contradiction board and see pairs. Not a list, not a table -- pairs. Each row is a confrontation: two memories, side by side, that cannot both be unconditionally true. The left card says one thing. The right card says something incompatible. Between them, a similarity score and a priority label. The board has already done the hard work of finding these conflicts. Your job is to decide what to do about them.</p>

  <p>The first pair is marked high priority. On the left: <code>Always use feature flags for new deployments</code>, stored by deploy-bot at 0.85 confidence, recalled eight times. On the right: <code>Feature flags add unnecessary complexity to deploys</code>, from fix-it-bot at 0.70 confidence, recalled three times. Cosine similarity: 0.89. The system notes "high semantic overlap with opposing conclusions." Both of these memories are about the same thing. Both were stored by agents that had good reason to believe what they learned. And they flatly disagree.</p>

  <p>Below the pair, four buttons. <em>Merge</em> produces a suggested synthesis: "Use feature flags for standard deploys; skip for hotfixes with team notification." <em>Keep Left</em> would archive the right memory. <em>Keep Right</em> would archive the left. <em>Both Valid</em> marks the pair as context-dependent and tags each memory with the conditions under which it applies. You click Merge. The two cards collapse inward with a smooth animation, replaced by a single resolved card with a green border. The stats update: "1 resolved."</p>

  <p>The second pair is medium priority. "Run full test suite before deploying" versus "Skip integration tests for hotfixes to save time." The third is low priority: "Always use HTTPS for external APIs" versus "Use HTTP for internal service mesh" -- the system has already flagged this as likely context-dependent rather than truly contradictory. Each pair invites a different kind of resolution. Some contradictions need merging. Some need context. Some were never really contradictions at all.</p>

  <h2 id="what-it-reveals">What it reveals</h2>

  <p>The contradiction board makes visible something that every multi-agent system accumulates silently: disagreement. When two agents operate independently, they learn from different experiences. Deploy-bot learns from a week of smooth feature-flag rollouts. Fix-it-bot learns from a weekend firefight where feature flags complicated the debugging process. Both are right. Both store their learnings at high confidence. And without the contradiction board, these two memories coexist invisibly, surfaced to whichever agent happens to query the right context at the right time.</p>

  <p>This is not a hypothetical problem. In any organization with more than one agent contributing to shared memory, contradictions are inevitable. They are the natural byproduct of distributed learning. Different agents encounter different situations. They draw different conclusions. The question is not whether contradictions will exist but whether anyone will ever notice them.</p>

  <p>The board also reveals a subtle failure mode of confidence scoring. Memory A has confidence 0.85. Memory B has confidence 0.70. Both are well above any reasonable threshold for recall. Confidence measures how strongly an agent believes something based on reinforcement -- how many times it was recalled, how often it proved useful. But confidence says nothing about whether a belief is consistent with other beliefs in the system. You can have two memories that are both high-confidence and mutually exclusive. The contradiction board is the first interface in this research series that treats coherence as a first-class concern, separate from and orthogonal to confidence.</p>

  <p>There is something uncomfortable about seeing contradictions laid bare. It implies the system has been operating with internal conflicts, potentially giving different agents different advice about the same situation. The board does not just fix this -- it makes you aware that it was happening. That awareness itself is valuable. It changes how you think about shared memory: not as a database of facts, but as a contested space where different experiences produce different truths.</p>

  <h2 id="deja-connection">How it connects to deja</h2>

  <p>Detection begins with pairwise cosine similarity. For any pool of shared memories, you compute the similarity between every pair of embeddings. Pairs above a threshold -- say 0.85 -- are candidates for contradiction. But high similarity alone is not sufficient. Two memories can be semantically similar and perfectly complementary: "Use HTTPS for security" and "Use TLS 1.3 for HTTPS connections" are highly similar and non-contradictory. The second stage is an LLM classification pass. For each high-similarity pair, a language model reads both memories and classifies the relationship as one of three categories: <em>complementary</em> (they reinforce each other), <em>contradictory</em> (they conflict), or <em>redundant</em> (they say the same thing differently).</p>

  <p>This two-stage pipeline -- embedding similarity followed by LLM classification -- is efficient enough to run periodically. For a memory pool of 50 shared learnings, there are 1,225 pairs. Filtering by cosine similarity above 0.85 might reduce this to 30-40 candidate pairs. Running LLM classification on 40 pairs is cheap. The result is a contradiction set that can be served from a new <code>/contradictions</code> endpoint, returning pairs with their similarity scores, classification labels, and suggested resolutions.</p>

  <p>Resolution actions map to existing deja operations. "Keep Left" is a <code>DELETE /learnings/:id</code> on the right memory. "Keep Right" is the inverse. "Merge" creates a new learning via <code>POST /learnings</code> and deletes both originals. "Both Valid" is the most interesting: it adds context metadata to both memories -- effectively scoping them to the conditions under which they apply. This might require a new <code>context_tags</code> field on the learning object, or it could use the existing trigger field to make the conditions explicit.</p>

  <p>The priority ranking uses a composite score: similarity times the product of both confidence scores. High similarity between two high-confidence memories is a more urgent contradiction than high similarity between a strong memory and a weak one. The weak one might simply be wrong. The strong-strong case is the genuinely hard problem -- both memories have been repeatedly validated by experience, yet they disagree.</p>

  <h2 id="design-tensions">Design tensions</h2>

  <p>The deepest tension in the contradiction board is the assumption that contradictions should be resolved. In human knowledge, contradictions are often productive. "Move fast and break things" and "Measure twice, cut once" are both valuable heuristics that directly contradict each other. The right one depends on context. A system that forces resolution might destroy useful tension.</p>

  <p>The "Both Valid" button is the escape valve for this tension, but it introduces its own complexity. Once two contradictory memories are marked as context-dependent, something needs to determine which context applies at recall time. This pushes complexity downstream: instead of resolving the contradiction in the board, you are delegating the resolution to the injection system, which must now evaluate context tags against the current situation. The contradiction is not resolved -- it is deferred.</p>

  <p>There is also a governance question. Who resolves contradictions? In a multi-agent system, the memories were created by different agents. Should a human always arbitrate? Should the higher-confidence memory win by default? Should the more-recalled memory take precedence? Each heuristic encodes a different epistemology. Confidence-wins says "believe what has been most reinforced." Recall-wins says "believe what has been most useful." Human-arbitrates says "believe what a person endorses." The contradiction board presents these as equal options, but in practice, teams will develop patterns. Those patterns reveal what the team actually values in its knowledge base.</p>

  <p>The merge operation deserves particular scrutiny. The suggested merged text -- "Use feature flags for standard deploys; skip for hotfixes with team notification" -- is a synthesis that neither original agent arrived at. It is new knowledge, generated by the resolution process itself. This is a rare case where the interface does not just display knowledge but creates it. The contradiction board is not read-only. It is a knowledge factory, producing nuanced learnings from the collision of simpler ones.</p>

  <h2 id="why-uniquely-important">Why uniquely important</h2>

  <p>Consider the state of a shared memory pool without contradiction detection. Agent A stores "always do X" at confidence 0.85. Agent B stores "never do X" at confidence 0.80. Both memories pass every quality check. Both are well-formed, high-confidence, properly scoped. When Agent C queries the pool about X, it might receive both memories, or whichever one has higher cosine similarity to the current context. The outcome depends on which embedding happens to be closer to the query vector. This is not knowledge management -- it is a coin flip dressed up as semantic search.</p>

  <p>The contradiction board is the only interface in this series that treats consistency as a dimension of memory quality. The filing cabinet shows you everything. The confidence heatmap shows you certainty. The decay garden shows you freshness. None of them show you coherence. You could have a memory pool where every individual memory is high-confidence, recently recalled, and properly scoped, and yet the pool as a whole is riddled with internal contradictions. Without the board, this condition is invisible.</p>

  <p>This matters most as memory pools scale. With ten memories, contradictions are rare and obvious. With a hundred, they are common and hidden. With a thousand, they are structural -- woven into the fabric of the knowledge base in ways that no single query would reveal. The contradiction board scales the detection. It makes the invisible structural problem into a visible, actionable list. Three pairs. Priority-ranked. Resolution buttons. The hardest epistemic problem in multi-agent systems, reduced to a manageable queue.</p>

</ResearchLayout>

<style>
  .cb-demo {
    max-height: 640px;
    overflow-y: auto;
  }

  .cb-priority-badge {
    border: 1px solid;
  }

  .cb-priority-badge.high {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.2);
  }

  .cb-priority-badge.medium {
    color: #c9a961;
    background: rgba(201, 169, 97, 0.1);
    border-color: rgba(201, 169, 97, 0.2);
  }

  .cb-priority-badge.low {
    color: #60a5fa;
    background: rgba(96, 165, 250, 0.1);
    border-color: rgba(96, 165, 250, 0.2);
  }

  .cb-action-btn {
    color: rgba(184, 184, 184, 0.5);
    background: transparent;
    border-color: rgba(201, 169, 97, 0.12);
    cursor: pointer;
  }

  .cb-action-btn:hover {
    color: #c9a961;
    background: rgba(201, 169, 97, 0.08);
    border-color: rgba(201, 169, 97, 0.3);
  }

  .cb-action-btn.merge:hover {
    color: #a78bfa;
    background: rgba(167, 139, 250, 0.08);
    border-color: rgba(167, 139, 250, 0.3);
  }

  .cb-action-btn.both-valid:hover {
    color: #60a5fa;
    background: rgba(96, 165, 250, 0.08);
    border-color: rgba(96, 165, 250, 0.3);
  }

  .cb-pair {
    transition: all 0.4s ease;
  }

  .cb-pair.resolving .cb-conflict-container {
    animation: cb-collapse 0.6s ease forwards;
  }

  .cb-pair.resolving .cb-actions {
    animation: cb-fade-out 0.3s ease forwards;
  }

  .cb-pair.resolved .cb-conflict-container {
    display: none;
  }

  .cb-pair.resolved .cb-actions {
    display: none;
  }

  .cb-pair.resolved .cb-pair-header {
    opacity: 0.5;
  }

  .cb-resolved-card {
    animation: cb-fade-in 0.4s ease;
  }

  @keyframes cb-collapse {
    0% {
      opacity: 1;
      max-height: 200px;
      transform: scaleY(1);
    }
    100% {
      opacity: 0;
      max-height: 0;
      transform: scaleY(0);
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  }

  @keyframes cb-fade-out {
    0% { opacity: 1; }
    100% { opacity: 0; height: 0; margin: 0; overflow: hidden; }
  }

  @keyframes cb-fade-in {
    0% { opacity: 0; transform: translateY(-8px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .cb-demo::-webkit-scrollbar {
    width: 3px;
  }

  .cb-demo::-webkit-scrollbar-track {
    background: transparent;
  }

  .cb-demo::-webkit-scrollbar-thumb {
    background: rgba(201, 169, 97, 0.15);
  }
</style>

<script>
  const mergedTexts = [
    "Use feature flags for standard deployments to enable gradual rollout; skip for hotfixes where speed is critical, with mandatory team notification",
    "Run full test suite for standard deploys; for hotfixes, run unit tests only and require two approvers to compensate for skipped integration tests",
    "Use HTTPS for all external API calls; HTTP is acceptable within the internal service mesh where mTLS handles encryption at the transport layer"
  ];

  const resolutionLabels: Record<string, string> = {
    'merge': 'Merged into unified learning',
    'keep-left': 'Kept Memory A, archived Memory B',
    'keep-right': 'Kept Memory B, archived Memory A',
    'both-valid': 'Both valid -- marked as context-dependent'
  };

  const bothValidTexts = [
    "Memory A applies to standard deployments. Memory B applies to emergency hotfixes. Context tags added: [standard-deploy] and [hotfix].",
    "Memory A applies to scheduled releases. Memory B applies to time-critical patches. Context tags added: [scheduled-release] and [critical-patch].",
    "Memory A applies to external-facing services. Memory B applies to internal service mesh. Context tags added: [external] and [internal-mesh]."
  ];

  let resolvedCount = 0;

  function updateStats() {
    const statsEl = document.getElementById('cb-stats');
    if (statsEl) {
      statsEl.textContent = `3 contradictions found across 47 shared memories. ${resolvedCount} resolved.`;
    }
  }

  document.querySelectorAll('.cb-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = (btn as HTMLElement).dataset.action!;
      const pairIdx = parseInt((btn as HTMLElement).dataset.pair!);
      const pairEl = document.querySelector(`.cb-pair[data-pair="${pairIdx}"]`) as HTMLElement;

      if (!pairEl || pairEl.dataset.resolved === 'true') return;

      pairEl.dataset.resolved = 'true';
      pairEl.classList.add('resolving');

      let resolvedText = '';
      if (action === 'merge') {
        resolvedText = mergedTexts[pairIdx];
      } else if (action === 'keep-left') {
        const leftText = pairEl.querySelector('.cb-memory-card.left p')?.textContent || '';
        resolvedText = leftText.replace(/"/g, '');
      } else if (action === 'keep-right') {
        const rightText = pairEl.querySelector('.cb-memory-card.right p')?.textContent || '';
        resolvedText = rightText.replace(/"/g, '');
      } else if (action === 'both-valid') {
        resolvedText = bothValidTexts[pairIdx];
      }

      setTimeout(() => {
        pairEl.classList.remove('resolving');
        pairEl.classList.add('resolved');

        const resolvedCard = pairEl.querySelector('.cb-resolved-card') as HTMLElement;
        const methodEl = resolvedCard.querySelector('.cb-resolution-method') as HTMLElement;
        const textEl = resolvedCard.querySelector('.cb-resolved-text') as HTMLElement;

        methodEl.textContent = resolutionLabels[action];
        textEl.textContent = resolvedText;
        resolvedCard.classList.remove('hidden');

        resolvedCount++;
        updateStats();
      }, 600);
    });
  });
</script>
