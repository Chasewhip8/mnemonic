---
import FailureModeLayout from '../../layouts/FailureModeLayout.astro';
import DoItWithDeja from '../../components/DoItWithDeja.astro';
import { getFailureModeBySlug } from '../../data/research';
const failureMode = getFailureModeBySlug('new-agent-no-context')!;
---

<FailureModeLayout failureMode={failureMode}>
  <Fragment slot="toc">
    <a href="#scenario" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Scenario</a>
    <a href="#what-was-needed" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What was needed</a>
    <a href="#minimal-interface" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Minimal interface</a>
    <a href="#do-it-with-deja" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Do it with deja</a>
  </Fragment>

  <h2 id="scenario">Scenario</h2>
  <p>The first agent hit three test failures, figured out two, and handed off. The second agent started from zero and re-investigated all three. You need the next agent (or the next run) to see what the previous run knew and decided — goal, key learnings, open questions — and optionally load that into its context.</p>

  <h2 id="what-was-needed">What was needed</h2>
  <p>A handoff summary for the last run: what was the goal, what learnings were created, what open questions remained. One "Load into this run" (or "Copy to prompt") so the next agent or human gets the briefing. No full event log — a curated packet.</p>

  <h2 id="minimal-interface">Minimal interface</h2>
  <p>Single view: run id, goal, list of learnings from that run (scope=agent or session), open questions if your state tracks them. Buttons: "Copy as markdown," "POST to queue for next agent." The receiving agent calls inject with the handoff context or ingests the learnings via a "load handoff" helper. Minimal = one run, one packet, one action.</p>

  <DoItWithDeja
    blurb="On run end: GET state + list learnings for that run. Serialize to a handoff JSON; POST to queue or show Copy / Load for next agent."
    snippets={[
      {
        label: 'Build handoff from last run',
        code: `const state = await fetch('/state?run_id=' + lastRunId).then(r => r.json());
const learnings = await fetch('/learnings?scope=agent:' + agentId).then(r => r.json());
const packet = {
  goal: state.goal,
  learnings: learnings.learnings?.filter(l => l.run_id === lastRunId) ?? [],
  open_questions: state.open_questions ?? []
};
// POST to queue or render; next agent GETs and merges into context.`,
      },
    ]}
  />
</FailureModeLayout>
