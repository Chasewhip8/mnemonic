---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('agents-instinct-panel')!;
---

<ResearchLayout concept={concept}>
  <div slot="demo">
    <div class="demo-container bg-void-deep border border-brass/10 rounded-sm overflow-hidden">
      <!-- Header bar -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-brass/10 bg-steel/30">
        <div class="flex items-center gap-3">
          <div class="w-2 h-2 rounded-full bg-brass/60 instinct-status-dot"></div>
          <span class="font-mono text-[11px] text-chrome-dark/70">deploy-bot run #247 -- live</span>
        </div>
        <button id="instinct-replay" class="font-mono text-[10px] px-3 py-1 border border-brass/20 rounded-sm text-brass hover:bg-brass/10 transition-colors cursor-pointer bg-transparent">
          Replay
        </button>
      </div>

      <!-- Two-panel layout -->
      <div class="instinct-panels">
        <!-- LEFT: Agent workspace -->
        <div class="instinct-workspace p-5 border-r border-brass/10">
          <div class="font-mono text-[10px] text-chrome-dark/30 uppercase tracking-widest mb-3">Agent Output</div>
          <div class="font-mono text-[13px] text-chrome-dark leading-relaxed" id="instinct-output">
            <span class="instinct-cursor"></span>
          </div>
        </div>

        <!-- RIGHT: Instinct panel -->
        <div class="instinct-sidebar p-4 bg-steel/20">
          <div class="font-mono text-[10px] text-brass uppercase tracking-widest mb-4">Active Memories</div>

          <!-- Memory cards -->
          <div class="space-y-3 mb-6" id="instinct-memories">
            <div class="instinct-memory-card p-3 rounded-sm border border-brass/10 bg-void-deep opacity-30" id="memory-1" data-active="false">
              <div class="font-serif text-[12px] text-chrome mb-1">Always check migration state</div>
              <div class="flex items-center justify-between">
                <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.90</span>
                <div class="instinct-glow-bar h-1 w-12 rounded-full bg-steel-light overflow-hidden">
                  <div class="h-full w-[90%] rounded-full bg-brass/30 instinct-bar-fill"></div>
                </div>
              </div>
            </div>

            <div class="instinct-memory-card p-3 rounded-sm border border-brass/10 bg-void-deep opacity-30" id="memory-2" data-active="false">
              <div class="font-serif text-[12px] text-chrome mb-1">Port conflicts on 8080</div>
              <div class="flex items-center justify-between">
                <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.70</span>
                <div class="instinct-glow-bar h-1 w-12 rounded-full bg-steel-light overflow-hidden">
                  <div class="h-full w-[70%] rounded-full bg-brass/30 instinct-bar-fill"></div>
                </div>
              </div>
            </div>

            <div class="instinct-memory-card p-3 rounded-sm border border-brass/10 bg-void-deep opacity-30" id="memory-3" data-active="false">
              <div class="font-serif text-[12px] text-chrome mb-1">Dry-run before deploying</div>
              <div class="flex items-center justify-between">
                <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.85</span>
                <div class="instinct-glow-bar h-1 w-12 rounded-full bg-steel-light overflow-hidden">
                  <div class="h-full w-[85%] rounded-full bg-brass/30 instinct-bar-fill"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Working state -->
          <div class="font-mono text-[10px] text-brass uppercase tracking-widest mb-3">Working State</div>
          <div class="space-y-2 mb-6" id="instinct-state">
            <div class="instinct-state-item hidden" id="state-goal">
              <div class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest">Goal</div>
              <div class="font-serif text-[12px] text-chrome-dark/70">Deploy auth service to production</div>
            </div>
            <div class="instinct-state-item hidden" id="state-question">
              <div class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest">Open Question</div>
              <div class="font-serif text-[12px] text-chrome-dark/70 instinct-pulse">Is port 8080 available?</div>
            </div>
            <div class="instinct-state-item hidden" id="state-decision">
              <div class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest">Decision</div>
              <div class="font-serif text-[12px] text-chrome-dark/70">
                <span class="text-brass mr-1">&#10003;</span> Run migration check first
              </div>
            </div>
          </div>

          <!-- Confidence average -->
          <div class="hidden" id="instinct-confidence-avg">
            <div class="font-mono text-[10px] text-brass uppercase tracking-widest mb-2">Confidence Average</div>
            <div class="flex items-center gap-3">
              <span class="font-mono text-[16px] text-chrome font-bold">0.82</span>
              <div class="flex-1 h-2 bg-steel-light rounded-full overflow-hidden">
                <div class="h-full bg-brass/60 rounded-full instinct-avg-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
  </Fragment>

  <h2 id="the-experience">The experience</h2>

  <p>You start a deployment run and split your screen. The left side shows the agent working -- text appearing, commands being composed, decisions forming in real time. The right side shows something new: a narrow panel labeled "Active Memories." It is mostly dark when the run begins. Then, as the agent encounters its first decision point, a card illuminates.</p>

  <p>The card reads: "Always check migration state." Confidence 0.90. It glows a steady brass, a warm pulse that says: this memory is active, this memory is influencing what happens next. The agent has not mentioned this memory in its output. It has not cited it or explained its reasoning. But the panel shows you that this prior belief is loaded, present, shaping the agent's behavior from underneath.</p>

  <p>A moment later, the agent's output mentions port 8080. A second card lights up: "Port conflicts on 8080." Confidence 0.70. The glow is dimmer -- not quite as certain, not quite as practiced. The agent has a memory about this, but it is holding it with moderate confidence. You can see the difference. The first memory is a conviction. The second is more like a suspicion.</p>

  <p>Below the memory cards, the Working State section populates in stages. First the goal appears: "Deploy auth service to production." Then an open question, pulsing gently: "Is port 8080 available?" The agent is uncertain about something. It has flagged this internally. Finally, a decision solidifies: "Run migration check first." A small checkmark appears beside it. The agent has committed to an action, and you can see the moment it happened.</p>

  <p>A third memory lights up: "Dry-run before deploying." Confidence 0.85. By now you have a real-time portrait of the agent's cognitive state -- what it remembers, what it is unsure about, what it has decided. The agent's output in the left panel is the artifact. The instinct panel on the right is the process. You are watching an agent think.</p>

  <p>The confidence average settles at 0.82, rendered as a small bar chart. The agent is operating from a strong knowledge base for this particular task. If the average were 0.4, you would see it and intervene. The number is a single-glance health indicator for the run in progress.</p>

  <h2 id="what-it-reveals">What it reveals</h2>

  <p>The instinct panel reveals the <strong>space between input and output</strong>. In most agent interactions, you provide a prompt and receive a result. What happens in between is opaque. The agent consults its memory, weighs options, resolves ambiguities -- and you see none of it. The instinct panel makes that intermediate state legible.</p>

  <p>This is transparency of a specific kind. It is not a debug log. It is not a trace of every function call. It is a curated view of what the agent considers relevant, how confident it is, and what decisions it is forming. The distinction matters. A debug log gives you everything, which means it gives you nothing useful without significant interpretation effort. The instinct panel gives you the three to five most salient facts about the agent's current cognitive state.</p>

  <p>The concept draws from cockpit instrumentation design. A pilot does not need to see every sensor reading at all times. A pilot needs the readings that are relevant to the current phase of flight, presented at the right level of abstraction. The instinct panel applies this principle to agent runs: show what is active, what is uncertain, and what has been decided. Hide the rest.</p>

  <p>There is a deeper insight here about the nature of trust. Trust in autonomous systems is often discussed in binary terms -- you trust the agent or you do not. But trust is actually granular and contextual. You might trust an agent's deployment knowledge but not its security knowledge. You might trust its judgment on routine tasks but not novel ones. The instinct panel supports this granularity by showing you the confidence values of the specific memories driving the current run. You are not asked to trust the agent in general. You are shown the specific basis for its current behavior and allowed to calibrate your trust accordingly.</p>

  <p>The "open questions" and "decisions" sections add temporal structure to transparency. An open question is a flag: the agent is uncertain, and the outcome of this uncertainty might matter. A decision is a commitment: the agent has resolved its uncertainty and chosen a path. Seeing these transitions happen in real time turns a passive monitoring experience into something more like collaboration. You are watching a colleague deliberate, and you can intervene at the moments that matter.</p>

  <h2 id="deja-connection">How it connects to deja</h2>

  <p>The instinct panel connects to deja through two mechanisms: state polling and inject result observation.</p>

  <p>The <code>/state</code> endpoint (or <code>state_get</code> in the SDK) returns the agent's current working state, including its active goal, open questions, and decisions. This endpoint already exists and is updated as the agent processes information during a run. Polling this endpoint at a regular interval -- say, every 500ms -- provides the data for the Working State section of the panel. The goal, questions, and decisions are already structured fields in the state response.</p>

  <p>The Active Memories section requires observing which memories are returned by <code>/inject</code> calls during the run. Each time the agent's context is enriched with recalled memories, those memories and their confidence scores become the data for the memory cards. In a WebSocket-based implementation, the server would push inject events to the client as they occur. In a polling-based implementation, the client would check a run-specific endpoint that accumulates inject results.</p>

  <p>The confidence average is a simple arithmetic mean of the confidence values of all memories injected during the run so far. This requires no new computation -- just aggregation of values already returned by the inject endpoint.</p>

  <p>One implementation detail worth noting: the instinct panel is most natural as a <strong>post-run replay</strong> rather than a true real-time view. Real-time observation of inject calls introduces latency concerns and requires either WebSocket infrastructure or aggressive polling. A replay mode -- where the entire run's memory interactions are recorded and played back with timing information -- provides the same insight without the infrastructure cost. The demo above simulates this replay approach: the animation plays through a recorded sequence of events, showing exactly what the agent remembered and when.</p>

  <p>The transition from replay to real-time is a matter of infrastructure, not concept. If the deja server supports WebSocket subscriptions for run events, the instinct panel becomes live. If not, replay is a fully functional alternative that captures the same information with a slight delay.</p>

  <h2 id="design-tensions">Design tensions</h2>

  <p>The primary tension in the instinct panel is <strong>latency versus relevance</strong>. If the panel updates in real time but the updates are a second behind the agent's output, the correspondence between "what the agent is doing" and "what the agent is thinking" breaks down. The memory that lights up should coincide with the moment the agent uses that memory, not arrive after the relevant output has already scrolled past. If the timing is wrong, the panel becomes noise rather than signal.</p>

  <p>The opposite failure mode is equally real: if the panel is perfectly synchronized, it may be <strong>overwhelming</strong>. An agent performing a complex task might recall fifteen memories in rapid succession, generate a dozen decisions, and cycle through multiple open questions -- all in a few seconds. Showing all of this in real time creates a flickering, anxiety-inducing display that is harder to parse than no display at all. The panel needs to be calm. It needs to show three to five items at most, rotating older items out as new ones become active. This requires editorial judgment about what to surface -- which is itself a non-trivial design problem.</p>

  <p>There is also a tension around <strong>the audience</strong>. A developer monitoring an agent run has different needs than a team lead reviewing whether the agent can be trusted with production access. The developer wants to see inject scores, embedding distances, and raw memory text. The team lead wants a high-level confidence summary and a list of decisions. The instinct panel as designed here splits the difference, showing structured information that is legible to both audiences but optimized for neither. A production version might need configurable detail levels.</p>

  <p>Perhaps the most interesting tension is philosophical: <strong>does transparency change behavior?</strong> If an agent "knows" (or if its developers know) that its memory recalls are being displayed to a human, does that change which memories are surfaced or how decisions are framed? In the current deja architecture, the answer is no -- memory recall is a function of embedding similarity and confidence, not of whether a panel is watching. But as agent systems become more sophisticated, the observer effect is worth considering. Transparency tools that influence the behavior they observe are a known problem in software monitoring. The instinct panel should display what is happening, not what should be happening.</p>

  <p>The practical recommendation is to <strong>start with post-run replay</strong>. It avoids the latency problem entirely, allows the viewer to pause and inspect specific moments, and requires no real-time infrastructure. Once the replay experience is validated and the UI patterns are stable, upgrading to live observation is a well-defined engineering task. The concept is the same. The timing is the variable.</p>
</ResearchLayout>

<style>
  .instinct-panels {
    display: grid;
    grid-template-columns: 1fr 280px;
    min-height: 360px;
  }

  @media (max-width: 768px) {
    .instinct-panels {
      grid-template-columns: 1fr;
    }
    .instinct-sidebar {
      border-top: 1px solid rgba(201, 169, 97, 0.1);
    }
  }

  .instinct-cursor {
    display: inline-block;
    width: 7px;
    height: 15px;
    background: rgba(201, 169, 97, 0.6);
    margin-left: 1px;
    vertical-align: text-bottom;
    animation: cursor-blink 0.8s step-end infinite;
  }

  @keyframes cursor-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .instinct-memory-card {
    transition: opacity 0.5s ease, box-shadow 0.5s ease, border-color 0.5s ease;
  }

  .instinct-memory-card[data-active="true"] {
    opacity: 1 !important;
    border-color: rgba(201, 169, 97, 0.4);
    box-shadow: 0 0 16px rgba(201, 169, 97, 0.15);
  }

  .instinct-memory-card[data-active="true"] .instinct-bar-fill {
    background: rgba(201, 169, 97, 0.7);
    transition: background 0.5s ease;
  }

  @keyframes memory-glow {
    0%, 100% { box-shadow: 0 0 16px rgba(201, 169, 97, 0.15); }
    50% { box-shadow: 0 0 24px rgba(201, 169, 97, 0.3); }
  }

  .instinct-memory-card[data-active="true"] {
    animation: memory-glow 2s ease-in-out infinite;
  }

  .instinct-state-item {
    padding: 6px 8px;
    border-left: 2px solid rgba(201, 169, 97, 0.15);
    transition: opacity 0.4s ease;
  }

  .instinct-state-item.visible {
    display: block !important;
    animation: state-enter 0.4s ease-out;
  }

  @keyframes state-enter {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .instinct-pulse {
    animation: text-pulse 2s ease-in-out infinite;
  }

  @keyframes text-pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }

  .instinct-status-dot {
    animation: dot-pulse 1.5s ease-in-out infinite;
  }

  @keyframes dot-pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .instinct-avg-bar {
    transition: width 1s ease-out;
  }
</style>

<script>
  const outputEl = document.getElementById('instinct-output');
  const replayBtn = document.getElementById('instinct-replay');
  const memory1 = document.getElementById('memory-1');
  const memory2 = document.getElementById('memory-2');
  const memory3 = document.getElementById('memory-3');
  const stateGoal = document.getElementById('state-goal');
  const stateQuestion = document.getElementById('state-question');
  const stateDecision = document.getElementById('state-decision');
  const confidenceAvg = document.getElementById('instinct-confidence-avg');

  const outputText = [
    { text: 'Analyzing deployment configuration...', delay: 0 },
    { text: '\n\nChecking auth service manifest. ', delay: 1200 },
    { text: 'The auth service needs port 8080 exposed. ', delay: 2400 },
    { text: 'Verifying no conflicts on that port.\n\n', delay: 3800 },
    { text: 'Checking migration state... ', delay: 5200 },
    { text: 'Database is 2 migrations behind. ', delay: 6200 },
    { text: 'Running migration check before proceeding.\n\n', delay: 7000 },
    { text: 'Initiating dry-run deployment to staging.', delay: 7800 },
  ];

  const events = [
    { time: 500, action: 'goal' },
    { time: 1000, action: 'memory1' },
    { time: 2600, action: 'memory2' },
    { time: 3500, action: 'question' },
    { time: 5500, action: 'decision' },
    { time: 6800, action: 'memory3' },
    { time: 7500, action: 'confidence' },
  ];

  let timeouts = [];

  function resetDemo() {
    timeouts.forEach(t => clearTimeout(t));
    timeouts = [];

    outputEl.innerHTML = '<span class="instinct-cursor"></span>';
    memory1.dataset.active = 'false';
    memory1.style.opacity = '0.3';
    memory2.dataset.active = 'false';
    memory2.style.opacity = '0.3';
    memory3.dataset.active = 'false';
    memory3.style.opacity = '0.3';
    stateGoal.classList.add('hidden');
    stateGoal.classList.remove('visible');
    stateQuestion.classList.add('hidden');
    stateQuestion.classList.remove('visible');
    stateDecision.classList.add('hidden');
    stateDecision.classList.remove('visible');
    confidenceAvg.classList.add('hidden');
    const avgBar = confidenceAvg.querySelector('.instinct-avg-bar');
    if (avgBar) avgBar.style.width = '0%';
  }

  function typeText(text, element, charDelay) {
    const cursor = element.querySelector('.instinct-cursor');
    let i = 0;
    function typeChar() {
      if (i < text.length) {
        const char = text[i];
        if (char === '\n') {
          cursor.insertAdjacentHTML('beforebegin', '<br>');
        } else {
          cursor.insertAdjacentText('beforebegin', char);
        }
        i++;
        const t = setTimeout(typeChar, charDelay);
        timeouts.push(t);
      }
    }
    typeChar();
  }

  function runDemo() {
    resetDemo();

    // Type output text
    outputText.forEach(segment => {
      const t = setTimeout(() => {
        typeText(segment.text, outputEl, 25);
      }, segment.delay);
      timeouts.push(t);
    });

    // Trigger events
    events.forEach(event => {
      const t = setTimeout(() => {
        switch (event.action) {
          case 'goal':
            stateGoal.classList.remove('hidden');
            stateGoal.classList.add('visible');
            break;
          case 'memory1':
            memory1.dataset.active = 'true';
            memory1.style.opacity = '1';
            break;
          case 'memory2':
            memory2.dataset.active = 'true';
            memory2.style.opacity = '1';
            break;
          case 'memory3':
            memory3.dataset.active = 'true';
            memory3.style.opacity = '1';
            break;
          case 'question':
            stateQuestion.classList.remove('hidden');
            stateQuestion.classList.add('visible');
            break;
          case 'decision':
            stateDecision.classList.remove('hidden');
            stateDecision.classList.add('visible');
            break;
          case 'confidence':
            confidenceAvg.classList.remove('hidden');
            const avgBar = confidenceAvg.querySelector('.instinct-avg-bar');
            setTimeout(() => { if (avgBar) avgBar.style.width = '82%'; }, 50);
            break;
        }
      }, event.time);
      timeouts.push(t);
    });
  }

  replayBtn.addEventListener('click', () => {
    runDemo();
  });

  // Auto-start after a brief delay
  setTimeout(runDemo, 600);
</script>
