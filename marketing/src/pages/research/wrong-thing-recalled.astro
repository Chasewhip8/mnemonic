---
import FailureModeLayout from '../../layouts/FailureModeLayout.astro';
import DoItWithDeja from '../../components/DoItWithDeja.astro';
import { getFailureModeBySlug } from '../../data/research';
const failureMode = getFailureModeBySlug('wrong-thing-recalled')!;
---

<FailureModeLayout failureMode={failureMode}>
  <Fragment slot="toc">
    <a href="#scenario" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Scenario</a>
    <a href="#what-was-needed" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What was needed</a>
    <a href="#minimal-interface" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Minimal interface</a>
    <a href="#do-it-with-deja" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Do it with deja</a>
  </Fragment>

  <h2 id="scenario">Scenario</h2>
  <p>The agent was supposed to use the new auth library. Instead it followed an old memory: "always use library X for authentication." The codebase had migrated to Y months ago. The task failed; the diff was wrong. You need to know why it chose that memory and what else was in the pool.</p>

  <h2 id="what-was-needed">What was needed</h2>
  <p>One screen: the last inject for this run. What context was sent? What did the vector search return (top-k with scores)? Which of those made it into the prompt? No timeline, no history — just "what was injected and why" for the run that just failed.</p>

  <h2 id="minimal-interface">Minimal interface</h2>
  <p>A single panel: context snippet, list of returned memories with similarity scores, and which ones were actually used. Click through to the memory if you need to edit or delete it. This is the Memory Debugger reduced to one view — no waterfall, no learn events, just the inject that went wrong.</p>

  <DoItWithDeja
    blurb="Log POST /inject request and response in your agent or worker. Store run_id, context, and returned learnings; render in a minimal panel for the failing run."
    snippets={[
      {
        label: 'Log inject for debugging',
        code: `// In your agent, after calling inject:
const res = await deja.inject({ context, scopes: ['shared'], limit: 5 });
console.log(JSON.stringify({
  run_id: runId,
  context: context.slice(0, 80),
  learnings: res.learnings?.map(l => ({ id: l.id, trigger: l.trigger?.slice(0, 50), score: l.score }))
}));
// In your UI: fetch run trace, show context + learnings for last inject.`,
      },
    ]}
  />
</FailureModeLayout>
