---
import ResearchLayout from '../../layouts/ResearchLayout.astro';
import { getConceptBySlug } from '../../data/research';
const concept = getConceptBySlug('learning-proposal-flow')!;
---

<ResearchLayout concept={concept}>
  <div slot="demo">
    <div class="demo-container bg-void-deep border border-brass/10 rounded-sm">
      <!-- Notification banner -->
      <div class="proposal-banner px-5 py-3 border-b border-brass/10 bg-brass/5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-5 h-5 rounded-full border border-brass/40 flex items-center justify-center">
            <span class="font-mono text-[10px] text-brass font-bold" id="proposal-count">4</span>
          </div>
          <span class="font-serif text-[13px] text-chrome">Your agent wants to remember <strong id="proposal-count-text">4 things</strong></span>
        </div>
        <span class="font-mono text-[10px] text-chrome-dark/40">deploy-bot, run #247</span>
      </div>

      <!-- Progress -->
      <div class="px-5 py-3 border-b border-brass/5 flex items-center justify-between">
        <div class="font-mono text-[10px] text-chrome-dark/50">
          <span id="progress-text">0 of 4 reviewed</span>
        </div>
        <div class="flex items-center gap-3">
          <button id="merge-btn" class="font-mono text-[10px] px-2 py-1 border border-brass/10 rounded-sm text-chrome-dark/40 cursor-not-allowed bg-transparent transition-colors" disabled>
            Merge selected (0)
          </button>
        </div>
      </div>

      <!-- Proposal cards -->
      <div class="p-5 space-y-3" id="proposals-container">
        <!-- Proposal 1 -->
        <div class="proposal-card" id="proposal-1" data-status="pending">
          <div class="proposal-card-inner p-4 bg-steel/50 border border-brass/10 rounded-sm transition-all duration-300">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <input type="checkbox" class="proposal-checkbox accent-brass w-3.5 h-3.5 cursor-pointer" data-id="1" />
                  <span class="font-serif text-[14px] text-chrome proposal-trigger-text">always verify SSL certs after deploy</span>
                </div>
                <div class="flex items-center gap-3 ml-6">
                  <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.80</span>
                  <span class="font-mono text-[10px] px-1.5 py-0.5 rounded-sm bg-brass/10 text-brass/70 border border-brass/10">shared</span>
                </div>
              </div>
            </div>
            <!-- Action buttons -->
            <div class="flex items-center gap-2 ml-6 proposal-actions">
              <button class="proposal-btn approve-btn font-mono text-[10px] px-3 py-1 border border-emerald-500/20 rounded-sm text-emerald-400/70 hover:bg-emerald-500/10 hover:text-emerald-400 transition-colors bg-transparent cursor-pointer" data-id="1">Approve</button>
              <button class="proposal-btn edit-btn font-mono text-[10px] px-3 py-1 border border-brass/20 rounded-sm text-brass/70 hover:bg-brass/10 hover:text-brass transition-colors bg-transparent cursor-pointer" data-id="1">Edit</button>
              <button class="proposal-btn reject-btn font-mono text-[10px] px-3 py-1 border border-red-500/20 rounded-sm text-red-400/70 hover:bg-red-500/10 hover:text-red-400 transition-colors bg-transparent cursor-pointer" data-id="1">Reject</button>
              <button class="proposal-btn scope-btn font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:bg-chrome-dark/5 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="1">Change Scope</button>
            </div>
            <!-- Edit form (hidden) -->
            <div class="proposal-edit-form hidden mt-3 ml-6 p-3 bg-void-deep border border-brass/10 rounded-sm space-y-2" data-id="1">
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Trigger</label>
                <input type="text" class="edit-trigger w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="after deploying to production" />
              </div>
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Learning</label>
                <input type="text" class="edit-learning w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="always verify SSL certs after deploy" />
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Confidence</label>
                  <input type="range" class="edit-confidence w-full accent-brass" min="0" max="100" value="80" />
                  <span class="font-mono text-[10px] text-chrome-dark/50 edit-confidence-value">0.80</span>
                </div>
                <div>
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Scope</label>
                  <select class="edit-scope bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                    <option value="shared" selected>shared</option>
                    <option value="agent:deploy-bot">agent:deploy-bot</option>
                    <option value="session:current">session:current</option>
                  </select>
                </div>
              </div>
              <div class="flex items-center gap-2 pt-1">
                <button class="edit-save font-mono text-[10px] px-3 py-1 bg-brass/20 border border-brass/30 rounded-sm text-brass hover:bg-brass/30 transition-colors cursor-pointer" data-id="1">Save</button>
                <button class="edit-cancel font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="1">Cancel</button>
              </div>
            </div>
            <!-- Scope dropdown (hidden) -->
            <div class="proposal-scope-dropdown hidden mt-2 ml-6 inline-flex items-center gap-2 p-2 bg-void-deep border border-brass/10 rounded-sm" data-id="1">
              <span class="font-mono text-[9px] text-chrome-dark/40">Scope:</span>
              <select class="scope-select bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                <option value="shared" selected>shared</option>
                <option value="agent:deploy-bot">agent:deploy-bot</option>
                <option value="session:current">session:current</option>
              </select>
              <button class="scope-apply font-mono text-[10px] px-2 py-0.5 bg-brass/20 border border-brass/20 rounded-sm text-brass cursor-pointer hover:bg-brass/30 transition-colors" data-id="1">Apply</button>
            </div>
          </div>
        </div>

        <!-- Proposal 2 -->
        <div class="proposal-card" id="proposal-2" data-status="pending">
          <div class="proposal-card-inner p-4 bg-steel/50 border border-brass/10 rounded-sm transition-all duration-300">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <input type="checkbox" class="proposal-checkbox accent-brass w-3.5 h-3.5 cursor-pointer" data-id="2" />
                  <span class="font-serif text-[14px] text-chrome proposal-trigger-text">canary deploys reduce blast radius</span>
                </div>
                <div class="flex items-center gap-3 ml-6">
                  <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.90</span>
                  <span class="font-mono text-[10px] px-1.5 py-0.5 rounded-sm bg-brass/10 text-brass/70 border border-brass/10">shared</span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 ml-6 proposal-actions">
              <button class="proposal-btn approve-btn font-mono text-[10px] px-3 py-1 border border-emerald-500/20 rounded-sm text-emerald-400/70 hover:bg-emerald-500/10 hover:text-emerald-400 transition-colors bg-transparent cursor-pointer" data-id="2">Approve</button>
              <button class="proposal-btn edit-btn font-mono text-[10px] px-3 py-1 border border-brass/20 rounded-sm text-brass/70 hover:bg-brass/10 hover:text-brass transition-colors bg-transparent cursor-pointer" data-id="2">Edit</button>
              <button class="proposal-btn reject-btn font-mono text-[10px] px-3 py-1 border border-red-500/20 rounded-sm text-red-400/70 hover:bg-red-500/10 hover:text-red-400 transition-colors bg-transparent cursor-pointer" data-id="2">Reject</button>
              <button class="proposal-btn scope-btn font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:bg-chrome-dark/5 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="2">Change Scope</button>
            </div>
            <div class="proposal-edit-form hidden mt-3 ml-6 p-3 bg-void-deep border border-brass/10 rounded-sm space-y-2" data-id="2">
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Trigger</label>
                <input type="text" class="edit-trigger w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="when deploying to production" />
              </div>
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Learning</label>
                <input type="text" class="edit-learning w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="canary deploys reduce blast radius" />
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Confidence</label>
                  <input type="range" class="edit-confidence w-full accent-brass" min="0" max="100" value="90" />
                  <span class="font-mono text-[10px] text-chrome-dark/50 edit-confidence-value">0.90</span>
                </div>
                <div>
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Scope</label>
                  <select class="edit-scope bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                    <option value="shared" selected>shared</option>
                    <option value="agent:deploy-bot">agent:deploy-bot</option>
                    <option value="session:current">session:current</option>
                  </select>
                </div>
              </div>
              <div class="flex items-center gap-2 pt-1">
                <button class="edit-save font-mono text-[10px] px-3 py-1 bg-brass/20 border border-brass/30 rounded-sm text-brass hover:bg-brass/30 transition-colors cursor-pointer" data-id="2">Save</button>
                <button class="edit-cancel font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="2">Cancel</button>
              </div>
            </div>
            <div class="proposal-scope-dropdown hidden mt-2 ml-6 inline-flex items-center gap-2 p-2 bg-void-deep border border-brass/10 rounded-sm" data-id="2">
              <span class="font-mono text-[9px] text-chrome-dark/40">Scope:</span>
              <select class="scope-select bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                <option value="shared" selected>shared</option>
                <option value="agent:deploy-bot">agent:deploy-bot</option>
                <option value="session:current">session:current</option>
              </select>
              <button class="scope-apply font-mono text-[10px] px-2 py-0.5 bg-brass/20 border border-brass/20 rounded-sm text-brass cursor-pointer hover:bg-brass/30 transition-colors" data-id="2">Apply</button>
            </div>
          </div>
        </div>

        <!-- Proposal 3 (with warning) -->
        <div class="proposal-card" id="proposal-3" data-status="pending">
          <div class="proposal-card-inner p-4 bg-steel/50 border border-brass/10 rounded-sm transition-all duration-300">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <input type="checkbox" class="proposal-checkbox accent-brass w-3.5 h-3.5 cursor-pointer" data-id="3" />
                  <span class="font-serif text-[14px] text-chrome proposal-trigger-text">skip integration tests for hotfixes</span>
                </div>
                <div class="flex items-center gap-3 ml-6">
                  <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.50</span>
                  <span class="font-mono text-[10px] px-1.5 py-0.5 rounded-sm bg-steel-light text-chrome-dark/60 border border-chrome-dark/10">agent:deploy-bot</span>
                </div>
              </div>
            </div>
            <!-- Warning -->
            <div class="ml-6 mb-3 px-3 py-2 bg-amber-500/5 border border-amber-500/15 rounded-sm">
              <span class="font-mono text-[10px] text-amber-400/80">Low confidence -- consider reviewing before approval</span>
            </div>
            <div class="flex items-center gap-2 ml-6 proposal-actions">
              <button class="proposal-btn approve-btn font-mono text-[10px] px-3 py-1 border border-emerald-500/20 rounded-sm text-emerald-400/70 hover:bg-emerald-500/10 hover:text-emerald-400 transition-colors bg-transparent cursor-pointer" data-id="3">Approve</button>
              <button class="proposal-btn edit-btn font-mono text-[10px] px-3 py-1 border border-brass/20 rounded-sm text-brass/70 hover:bg-brass/10 hover:text-brass transition-colors bg-transparent cursor-pointer" data-id="3">Edit</button>
              <button class="proposal-btn reject-btn font-mono text-[10px] px-3 py-1 border border-red-500/20 rounded-sm text-red-400/70 hover:bg-red-500/10 hover:text-red-400 transition-colors bg-transparent cursor-pointer" data-id="3">Reject</button>
              <button class="proposal-btn scope-btn font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:bg-chrome-dark/5 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="3">Change Scope</button>
            </div>
            <div class="proposal-edit-form hidden mt-3 ml-6 p-3 bg-void-deep border border-brass/10 rounded-sm space-y-2" data-id="3">
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Trigger</label>
                <input type="text" class="edit-trigger w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="when handling a hotfix" />
              </div>
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Learning</label>
                <input type="text" class="edit-learning w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="skip integration tests for hotfixes" />
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Confidence</label>
                  <input type="range" class="edit-confidence w-full accent-brass" min="0" max="100" value="50" />
                  <span class="font-mono text-[10px] text-chrome-dark/50 edit-confidence-value">0.50</span>
                </div>
                <div>
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Scope</label>
                  <select class="edit-scope bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                    <option value="shared">shared</option>
                    <option value="agent:deploy-bot" selected>agent:deploy-bot</option>
                    <option value="session:current">session:current</option>
                  </select>
                </div>
              </div>
              <div class="flex items-center gap-2 pt-1">
                <button class="edit-save font-mono text-[10px] px-3 py-1 bg-brass/20 border border-brass/30 rounded-sm text-brass hover:bg-brass/30 transition-colors cursor-pointer" data-id="3">Save</button>
                <button class="edit-cancel font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="3">Cancel</button>
              </div>
            </div>
            <div class="proposal-scope-dropdown hidden mt-2 ml-6 inline-flex items-center gap-2 p-2 bg-void-deep border border-brass/10 rounded-sm" data-id="3">
              <span class="font-mono text-[9px] text-chrome-dark/40">Scope:</span>
              <select class="scope-select bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                <option value="shared">shared</option>
                <option value="agent:deploy-bot" selected>agent:deploy-bot</option>
                <option value="session:current">session:current</option>
              </select>
              <button class="scope-apply font-mono text-[10px] px-2 py-0.5 bg-brass/20 border border-brass/20 rounded-sm text-brass cursor-pointer hover:bg-brass/30 transition-colors" data-id="3">Apply</button>
            </div>
          </div>
        </div>

        <!-- Proposal 4 -->
        <div class="proposal-card" id="proposal-4" data-status="pending">
          <div class="proposal-card-inner p-4 bg-steel/50 border border-brass/10 rounded-sm transition-all duration-300">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <input type="checkbox" class="proposal-checkbox accent-brass w-3.5 h-3.5 cursor-pointer" data-id="4" />
                  <span class="font-serif text-[14px] text-chrome proposal-trigger-text">rollback threshold is 5 minutes</span>
                </div>
                <div class="flex items-center gap-3 ml-6">
                  <span class="font-mono text-[10px] text-chrome-dark/50">confidence: 0.85</span>
                  <span class="font-mono text-[10px] px-1.5 py-0.5 rounded-sm bg-brass/10 text-brass/70 border border-brass/10">shared</span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 ml-6 proposal-actions">
              <button class="proposal-btn approve-btn font-mono text-[10px] px-3 py-1 border border-emerald-500/20 rounded-sm text-emerald-400/70 hover:bg-emerald-500/10 hover:text-emerald-400 transition-colors bg-transparent cursor-pointer" data-id="4">Approve</button>
              <button class="proposal-btn edit-btn font-mono text-[10px] px-3 py-1 border border-brass/20 rounded-sm text-brass/70 hover:bg-brass/10 hover:text-brass transition-colors bg-transparent cursor-pointer" data-id="4">Edit</button>
              <button class="proposal-btn reject-btn font-mono text-[10px] px-3 py-1 border border-red-500/20 rounded-sm text-red-400/70 hover:bg-red-500/10 hover:text-red-400 transition-colors bg-transparent cursor-pointer" data-id="4">Reject</button>
              <button class="proposal-btn scope-btn font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:bg-chrome-dark/5 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="4">Change Scope</button>
            </div>
            <div class="proposal-edit-form hidden mt-3 ml-6 p-3 bg-void-deep border border-brass/10 rounded-sm space-y-2" data-id="4">
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Trigger</label>
                <input type="text" class="edit-trigger w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="when deciding to rollback" />
              </div>
              <div>
                <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Learning</label>
                <input type="text" class="edit-learning w-full bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none focus:border-brass/30" value="rollback threshold is 5 minutes" />
              </div>
              <div class="flex items-center gap-4">
                <div class="flex-1">
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Confidence</label>
                  <input type="range" class="edit-confidence w-full accent-brass" min="0" max="100" value="85" />
                  <span class="font-mono text-[10px] text-chrome-dark/50 edit-confidence-value">0.85</span>
                </div>
                <div>
                  <label class="font-mono text-[9px] text-chrome-dark/40 uppercase tracking-widest block mb-1">Scope</label>
                  <select class="edit-scope bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                    <option value="shared" selected>shared</option>
                    <option value="agent:deploy-bot">agent:deploy-bot</option>
                    <option value="session:current">session:current</option>
                  </select>
                </div>
              </div>
              <div class="flex items-center gap-2 pt-1">
                <button class="edit-save font-mono text-[10px] px-3 py-1 bg-brass/20 border border-brass/30 rounded-sm text-brass hover:bg-brass/30 transition-colors cursor-pointer" data-id="4">Save</button>
                <button class="edit-cancel font-mono text-[10px] px-3 py-1 border border-chrome-dark/10 rounded-sm text-chrome-dark/50 hover:text-chrome-dark/70 transition-colors bg-transparent cursor-pointer" data-id="4">Cancel</button>
              </div>
            </div>
            <div class="proposal-scope-dropdown hidden mt-2 ml-6 inline-flex items-center gap-2 p-2 bg-void-deep border border-brass/10 rounded-sm" data-id="4">
              <span class="font-mono text-[9px] text-chrome-dark/40">Scope:</span>
              <select class="scope-select bg-steel border border-brass/10 rounded-sm px-2 py-1 font-mono text-[11px] text-chrome outline-none">
                <option value="shared" selected>shared</option>
                <option value="agent:deploy-bot">agent:deploy-bot</option>
                <option value="session:current">session:current</option>
              </select>
              <button class="scope-apply font-mono text-[10px] px-2 py-0.5 bg-brass/20 border border-brass/20 rounded-sm text-brass cursor-pointer hover:bg-brass/30 transition-colors" data-id="4">Apply</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="px-5 py-4 border-t border-brass/10 bg-steel/20">
        <div class="flex items-center gap-6">
          <div class="font-mono text-[10px] text-chrome-dark/40 uppercase tracking-widest">Summary</div>
          <div class="flex items-center gap-4">
            <span class="font-mono text-[11px]"><span class="text-emerald-400" id="summary-approved">0</span> <span class="text-chrome-dark/40">approved</span></span>
            <span class="font-mono text-[11px]"><span class="text-red-400" id="summary-rejected">0</span> <span class="text-chrome-dark/40">rejected</span></span>
            <span class="font-mono text-[11px]"><span class="text-chrome-dark/60" id="summary-pending">4</span> <span class="text-chrome-dark/40">pending</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Fragment slot="toc">
    <a href="#the-experience" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">The experience</a>
    <a href="#what-it-reveals" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">What it reveals</a>
    <a href="#deja-connection" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Deja connection</a>
    <a href="#design-tensions" class="block py-1 text-[12px] font-serif text-chrome-dark/50 hover:text-brass transition-colors">Design tensions</a>
  </Fragment>

  <h2 id="the-experience">The experience</h2>

  <p>The run finishes. A notification appears: "Your agent wants to remember 4 things." Not an alert, not an error -- a request. The agent has completed its work, drawn conclusions, and now asks permission before those conclusions become permanent memory. This is the learning proposal flow.</p>

  <p>You open the queue and see four cards. Each one represents something the agent believes it learned during the run. The first: "always verify SSL certs after deploy." Confidence 0.80, scope shared. The agent encountered an SSL issue during deployment, resolved it, and now proposes that this resolution become a permanent learning -- one that will be recalled in future runs, not just by this agent but by any agent operating in the shared scope.</p>

  <p>The second proposal is similar: "canary deploys reduce blast radius." Confidence 0.90. This is a high-conviction learning. The agent is quite sure about this one. The shared scope means it wants all agents to benefit from this knowledge.</p>

  <p>The third proposal gives you pause. "Skip integration tests for hotfixes." Confidence 0.50. A warning label: "Low confidence -- consider reviewing before approval." The agent is not sure about this one. It observed a case where skipping tests during a hotfix worked out, but the confidence is low enough that the system flags it for extra scrutiny. The scope is narrower too: agent:deploy-bot only. Even the agent seems to sense this should not be shared broadly.</p>

  <p>The fourth: "rollback threshold is 5 minutes." Confidence 0.85, shared scope. A specific operational parameter that the agent learned from experience.</p>

  <p>You work through the queue. You approve the first two -- they represent sound operational practices that should be widely available. You reject the third -- skipping integration tests is too risky to encode as a permanent learning, even at agent scope. You click "Edit" on the fourth and adjust the confidence down to 0.75, because you know the rollback threshold varies by service. You change the scope to agent:deploy-bot, since this threshold is specific to the deployment workflow rather than a universal truth.</p>

  <p>As you make decisions, the summary updates: "Approved: 2, Rejected: 1, Pending: 1." Each resolved card animates away -- approved cards turn green and slide out with a checkmark, rejected cards turn red and slide out with an X. The queue shrinks. When you finish, the banner updates: "All proposals reviewed." The agent's proposed learnings have been filtered through human judgment.</p>

  <h2 id="what-it-reveals">What it reveals</h2>

  <p>The learning proposal flow reveals a fundamental question about autonomous systems: <strong>who decides what gets remembered?</strong> In most current agent implementations, the answer is the agent itself. If the agent calls a learn endpoint, the learning is stored. Period. There is no review, no approval, no quality gate. The agent's judgment about what is worth remembering is final.</p>

  <p>This works when agents operate in isolation with narrow scope. A personal coding assistant that remembers your preferred formatting style -- the stakes of a bad memory are low. But when agents operate in shared scope, when one agent's learning becomes another agent's prior belief, the calculus changes entirely. A single poorly-formed memory can propagate through an entire agent fleet, influencing decisions it was never meant to influence.</p>

  <p>Consider the third proposal: "skip integration tests for hotfixes." If this were stored at shared scope without review, every agent in the organization would eventually recall it during hotfix scenarios. Some might skip integration tests in contexts where that is genuinely dangerous. The original agent formed this belief from a single data point -- one hotfix where skipping tests worked fine. But a single data point is not sufficient basis for an organizational policy. The proposal flow catches this.</p>

  <p>The proposal flow also reveals something about the <strong>granularity of control</strong>. The four actions -- approve, edit, reject, and change scope -- correspond to four different judgments a human might make about a proposed learning:</p>

  <ul>
    <li><strong>Approve:</strong> The learning is correct and the scope is appropriate. Store it as-is.</li>
    <li><strong>Edit:</strong> The learning captures something real but the formulation needs adjustment. The confidence might be too high or too low. The trigger text might be too broad or too narrow.</li>
    <li><strong>Reject:</strong> The learning is wrong, premature, or not worth storing. Discard it entirely.</li>
    <li><strong>Change Scope:</strong> The learning is valid but should affect a different audience. A shared learning might need to be narrowed to agent-specific. An agent-specific learning might deserve promotion to shared.</li>
  </ul>

  <p>The merge capability adds a fifth judgment: two proposals that say related things might be better expressed as a single, more nuanced learning. This is editorial work -- the kind of synthesis that humans are good at and agents struggle with. The proposal flow creates space for it.</p>

  <h2 id="deja-connection">How it connects to deja</h2>

  <p>Implementing the learning proposal flow in deja requires three additions to the existing architecture.</p>

  <p>First, a <strong>status field</strong> on the memory record. Currently, when <code>/learn</code> is called, the memory is immediately active -- it can be recalled by <code>/inject</code> on the next request. The proposal flow adds an intermediate state: <code>proposed</code>. A memory with status <code>proposed</code> exists in the database but is excluded from inject results. It sits in a holding pattern until a human reviews it. Upon approval, the status changes to <code>active</code>. Upon rejection, the memory is either deleted or moved to a <code>rejected</code> state for auditing purposes.</p>

  <p>The status lifecycle would be: <code>proposed</code> (created by agent, awaiting review) to <code>active</code> (approved, available for recall) or <code>rejected</code> (denied, excluded from recall). An optional <code>archived</code> status could handle memories that were once active but are no longer needed.</p>

  <p>Second, a <strong>requireApproval flag</strong> on the <code>/learn</code> endpoint. Not every learning needs human review. A session-scoped memory with low impact might be fine to store immediately. A shared-scoped memory that will affect all agents probably needs review. The <code>requireApproval</code> parameter lets the caller specify whether the learning should be immediately active or should enter the proposal queue. A sensible default policy might be: shared scope always requires approval, agent scope optionally requires it, session scope never requires it.</p>

  <p>Third, a <strong><code>/proposals</code> endpoint</strong> that returns all memories with status <code>proposed</code>, grouped by run or agent. This is what the UI calls to populate the review queue. The endpoint would support filtering by agent, scope, and confidence range, as well as batch operations for approve-all or reject-all workflows. Each proposal would include context about the run that generated it -- what the agent was doing, what prompted the learning, and what memories were active at the time.</p>

  <p>The data model change is small. The API surface grows by one endpoint. The inject query adds a <code>WHERE status = 'active'</code> clause. The conceptual shift, though, is significant: deja moves from being a memory store to being a memory store with governance. The distinction matters at organizational scale.</p>

  <h2 id="design-tensions">Design tensions</h2>

  <p>The learning proposal flow matters most at <strong>shared scope</strong>. When one agent proposes a learning that will affect all agents, the stakes are highest and the need for human oversight is greatest. This is the scenario where a single bad memory can cause fleet-wide behavioral changes. The proposal flow is the quality gate that prevents this.</p>

  <p>But this creates a tension around <strong>throughput</strong>. If an agent generates twenty learnings per run and runs ten times per day, that is two hundred proposals per day for a single agent. A team running five agents generates a thousand proposals per day. At that volume, the proposal queue becomes a bottleneck. The human reviewer cannot keep up, proposals accumulate, and the system degrades into either rubber-stamping (approve all without reading) or neglect (proposals sit unreviewed indefinitely).</p>

  <p>The solution is probably <strong>selective gating</strong>. Not every learning needs review. The system should apply heuristics: require approval for shared scope, high-confidence learnings that will influence many future runs, and learnings that contradict existing memories. Skip approval for session-scoped learnings, learnings that reinforce existing knowledge, and learnings with very low confidence that will naturally decay. The goal is to funnel human attention to the decisions that matter most -- the ten proposals out of a thousand that could genuinely change agent behavior at scale.</p>

  <p>There is also a tension around <strong>timing</strong>. When should the proposal notification arrive? Immediately after the run ends? At the end of the workday? On a weekly cadence? Immediate notification interrupts workflow. Batched notification risks staleness -- by the time you review a proposal from three days ago, the context has shifted and you cannot evaluate it well. The right cadence probably depends on the scope: shared-scope proposals might warrant immediate notification, while agent-scope proposals can batch.</p>

  <p>The <strong>merge operation</strong> introduces its own complexity. Two proposals might seem related to a human but occupy very different regions of embedding space. Merging them into a single learning requires generating a new embedding for the merged text, which might place it in a region that no longer matches the original contexts. The merged memory might be semantically coherent to a human but geometrically awkward in the vector space. This is a tractable problem -- re-embed the merged text and accept the new position -- but it is worth acknowledging that merge is not a simple concatenation.</p>

  <p>Despite these tensions, the learning proposal flow is arguably the <strong>most impactful near-term addition</strong> to deja. It requires minimal API changes, addresses a genuine governance concern, and provides immediate value to any team running agents in shared scope. It is also the feature most likely to build trust with enterprise users, who will not adopt autonomous memory systems without oversight mechanisms. The proposal flow is not just a feature. It is a precondition for organizational adoption.</p>

  <p>The simplest version -- a status field, a requireApproval flag, and a proposals endpoint -- could be built in a few days. The UI patterns are well-established: every code review tool, every content moderation queue, every approval workflow in enterprise software follows the same basic shape. The novel part is not the approval flow itself. The novel part is applying it to agent memory -- treating beliefs as artifacts that deserve the same review rigor as code changes. That conceptual shift is the real contribution of this research.</p>
</ResearchLayout>

<style>
  .proposal-card {
    transition: all 0.4s ease;
    transform-origin: top center;
  }

  .proposal-card.approved {
    animation: card-approve 0.5s ease-out forwards;
  }

  .proposal-card.rejected {
    animation: card-reject 0.5s ease-out forwards;
  }

  @keyframes card-approve {
    0% { opacity: 1; transform: translateX(0) scale(1); }
    50% { opacity: 0.8; transform: translateX(10px) scale(0.98); }
    100% { opacity: 0; transform: translateX(30px) scale(0.95); max-height: 0; margin: 0; padding: 0; overflow: hidden; }
  }

  @keyframes card-reject {
    0% { opacity: 1; transform: translateX(0) scale(1); }
    50% { opacity: 0.8; transform: translateX(-10px) scale(0.98); }
    100% { opacity: 0; transform: translateX(-30px) scale(0.95); max-height: 0; margin: 0; padding: 0; overflow: hidden; }
  }

  .proposal-card.approved .proposal-card-inner {
    border-color: rgba(52, 211, 153, 0.3);
    background: rgba(52, 211, 153, 0.05);
  }

  .proposal-card.rejected .proposal-card-inner {
    border-color: rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.05);
  }

  .proposal-card-inner {
    position: relative;
  }

  .proposal-result-icon {
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    font-size: 18px;
    font-weight: bold;
    animation: icon-appear 0.3s ease-out;
  }

  @keyframes icon-appear {
    from { opacity: 0; transform: translateY(-50%) scale(0.5); }
    to { opacity: 1; transform: translateY(-50%) scale(1); }
  }
</style>

<script>
  const state = {
    approved: 0,
    rejected: 0,
    pending: 4,
    reviewed: 0,
    total: 4,
    selected: new Set(),
  };

  function updateSummary() {
    document.getElementById('summary-approved').textContent = state.approved;
    document.getElementById('summary-rejected').textContent = state.rejected;
    document.getElementById('summary-pending').textContent = state.pending;
    document.getElementById('progress-text').textContent = `${state.reviewed} of ${state.total} reviewed`;
    document.getElementById('proposal-count').textContent = state.pending;
    document.getElementById('proposal-count-text').textContent = `${state.pending} thing${state.pending !== 1 ? 's' : ''}`;
  }

  function resolveProposal(id, action) {
    const card = document.getElementById(`proposal-${id}`);
    if (!card || card.dataset.status !== 'pending') return;

    card.dataset.status = action;
    const inner = card.querySelector('.proposal-card-inner');

    // Add result icon
    const icon = document.createElement('span');
    icon.className = 'proposal-result-icon';

    if (action === 'approved') {
      icon.textContent = '\u2713';
      icon.style.color = 'rgba(52, 211, 153, 0.8)';
      state.approved++;
    } else {
      icon.textContent = '\u2717';
      icon.style.color = 'rgba(239, 68, 68, 0.8)';
      state.rejected++;
    }

    inner.appendChild(icon);
    state.pending--;
    state.reviewed++;
    updateSummary();

    // Animate out after brief pause
    setTimeout(() => {
      card.classList.add(action);
    }, 300);

    // Remove from DOM after animation
    setTimeout(() => {
      card.style.display = 'none';
    }, 900);
  }

  // Approve buttons
  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      resolveProposal(btn.dataset.id, 'approved');
    });
  });

  // Reject buttons
  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      resolveProposal(btn.dataset.id, 'rejected');
    });
  });

  // Edit buttons
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const form = document.querySelector(`.proposal-edit-form[data-id="${id}"]`);
      const scopeDropdown = document.querySelector(`.proposal-scope-dropdown[data-id="${id}"]`);
      if (form) {
        form.classList.toggle('hidden');
        if (scopeDropdown) scopeDropdown.classList.add('hidden');
      }
    });
  });

  // Edit save buttons
  document.querySelectorAll('.edit-save').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const form = document.querySelector(`.proposal-edit-form[data-id="${id}"]`);
      const card = document.getElementById(`proposal-${id}`);
      if (form && card) {
        const newLearning = form.querySelector('.edit-learning').value;
        const triggerText = card.querySelector('.proposal-trigger-text');
        if (triggerText) triggerText.textContent = newLearning;
        form.classList.add('hidden');
      }
    });
  });

  // Edit cancel buttons
  document.querySelectorAll('.edit-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const form = document.querySelector(`.proposal-edit-form[data-id="${id}"]`);
      if (form) form.classList.add('hidden');
    });
  });

  // Scope buttons
  document.querySelectorAll('.scope-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const dropdown = document.querySelector(`.proposal-scope-dropdown[data-id="${id}"]`);
      const form = document.querySelector(`.proposal-edit-form[data-id="${id}"]`);
      if (dropdown) {
        dropdown.classList.toggle('hidden');
        if (form) form.classList.add('hidden');
      }
    });
  });

  // Scope apply buttons
  document.querySelectorAll('.scope-apply').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const dropdown = document.querySelector(`.proposal-scope-dropdown[data-id="${id}"]`);
      const card = document.getElementById(`proposal-${id}`);
      if (dropdown && card) {
        const select = dropdown.querySelector('.scope-select');
        const scopeBadge = card.querySelectorAll('.font-mono.text-\\[10px\\]')[1];
        // Update the scope badge text (find the one with px-1.5)
        const badges = card.querySelectorAll('[class*="px-1.5"]');
        if (badges.length > 0) {
          badges[0].textContent = select.value;
        }
        dropdown.classList.add('hidden');
      }
    });
  });

  // Confidence sliders
  document.querySelectorAll('.edit-confidence').forEach(slider => {
    slider.addEventListener('input', (e) => {
      const form = e.target.closest('.proposal-edit-form');
      const valueEl = form.querySelector('.edit-confidence-value');
      if (valueEl) {
        valueEl.textContent = (e.target.value / 100).toFixed(2);
      }
    });
  });

  // Checkboxes for merge
  document.querySelectorAll('.proposal-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const id = e.target.dataset.id;
      if (e.target.checked) {
        state.selected.add(id);
      } else {
        state.selected.delete(id);
      }
      const mergeBtn = document.getElementById('merge-btn');
      if (state.selected.size >= 2) {
        mergeBtn.textContent = `Merge selected (${state.selected.size})`;
        mergeBtn.disabled = false;
        mergeBtn.classList.remove('cursor-not-allowed', 'text-chrome-dark/40');
        mergeBtn.classList.add('cursor-pointer', 'text-brass', 'border-brass/20', 'hover:bg-brass/10');
      } else {
        mergeBtn.textContent = `Merge selected (${state.selected.size})`;
        mergeBtn.disabled = true;
        mergeBtn.classList.add('cursor-not-allowed', 'text-chrome-dark/40');
        mergeBtn.classList.remove('cursor-pointer', 'text-brass', 'border-brass/20', 'hover:bg-brass/10');
      }
    });
  });

  // Merge button
  document.getElementById('merge-btn').addEventListener('click', () => {
    if (state.selected.size < 2) return;

    const ids = Array.from(state.selected);
    const texts = [];
    ids.forEach(id => {
      const card = document.getElementById(`proposal-${id}`);
      if (card) {
        const triggerText = card.querySelector('.proposal-trigger-text');
        if (triggerText) texts.push(triggerText.textContent);
      }
    });

    // Hide merged cards except the first
    const keepId = ids[0];
    ids.slice(1).forEach(id => {
      const card = document.getElementById(`proposal-${id}`);
      if (card) {
        card.dataset.status = 'merged';
        card.style.opacity = '0';
        setTimeout(() => { card.style.display = 'none'; }, 300);
        state.pending--;
        state.total--;
        state.reviewed = state.approved + state.rejected;
      }
    });

    // Update the kept card with merged text
    const keepCard = document.getElementById(`proposal-${keepId}`);
    if (keepCard) {
      const triggerText = keepCard.querySelector('.proposal-trigger-text');
      if (triggerText) {
        triggerText.textContent = texts.join(' + ');
        triggerText.style.color = '#c9a961';
      }
    }

    // Clear selection
    state.selected.clear();
    document.querySelectorAll('.proposal-checkbox').forEach(cb => { cb.checked = false; });
    const mergeBtn = document.getElementById('merge-btn');
    mergeBtn.textContent = 'Merge selected (0)';
    mergeBtn.disabled = true;
    mergeBtn.classList.add('cursor-not-allowed', 'text-chrome-dark/40');
    mergeBtn.classList.remove('cursor-pointer', 'text-brass', 'border-brass/20', 'hover:bg-brass/10');

    updateSummary();
  });
</script>
