
 RUN  v3.2.4 /home/chase/deja

 ✓ test/deja.test.ts > learn + inject/query/trace > learn + inject round-trip 67ms
 ✓ test/deja.test.ts > learn + inject/query/trace > learn + query 43ms
 ✓ test/deja.test.ts > learn + inject/query/trace > inject trace 52ms
 ✓ test/deja.test.ts > learning endpoints > learning CRUD (learn, list, delete by id) 44ms
 ✓ test/deja.test.ts > learning endpoints > bulk delete (confidence_lt filter) 108ms
 ✓ test/deja.test.ts > learning endpoints > learning neighbors 47ms
 ✓ test/deja.test.ts > learning endpoints > stats 72ms
 ✓ test/deja.test.ts > secrets > secrets CRUD (set, get, delete) 22ms
 ✓ test/deja.test.ts > state lifecycle > state lifecycle (PUT, GET, PATCH, POST events) 30ms
 ✓ test/deja.test.ts > state lifecycle > state resolve with persistToLearn=true 72ms
 ✓ test/deja.test.ts > mcp > MCP initialize 4ms
 ✓ test/deja.test.ts > mcp > MCP tools/list 2ms
 ✓ test/deja.test.ts > mcp > MCP tools/call learn 30ms
 ✓ test/deja.test.ts > mcp > MCP tools/call inject 49ms
 ✓ test/deja.test.ts > health + auth > health GET / 3ms
 ✓ test/deja.test.ts > health + auth > auth rejected (no bearer -> 401) 2ms
 ✓ test/deja.test.ts > health + auth > auth bypass (no API_KEY env -> all pass) 547ms
 ✓ test/learnings-extended.test.ts > bulk delete filters > not_recalled_in_days filter 236ms
 ✓ test/learnings-extended.test.ts > bulk delete filters > scope-only filter 111ms
 ✓ test/learnings-extended.test.ts > bulk delete filters > combined filters (confidence_lt + scope) 165ms
 ✓ test/learnings-extended.test.ts > bulk delete filters > no-filter validation 2ms
 ✓ test/learnings-extended.test.ts > scope priority > session > shared 89ms
 ✓ test/learnings-extended.test.ts > scope priority > agent > shared 118ms
 ✓ test/learnings-extended.test.ts > scope priority > empty scopes 4ms
 ✓ test/learnings-extended.test.ts > recall tracking > recall tracking updates last_recalled_at and recall_count 62ms
 ✓ test/learnings-extended.test.ts > inject variations > format: 'learnings' 51ms
 ✓ test/learnings-extended.test.ts > inject variations > includeState + runId 91ms
 ✓ test/mcp-tools.test.ts > mcp tools > inject_trace returns candidates, metadata, and injected results 102ms
 ✓ test/mcp-tools.test.ts > mcp tools > query returns matching learnings and per-scope hits 52ms
 ✓ test/mcp-tools.test.ts > mcp tools > forget deletes a learning and list no longer includes it 52ms
 ✓ test/mcp-tools.test.ts > mcp tools > forget_bulk deletes low-confidence learnings by scope 74ms
 ✓ test/mcp-tools.test.ts > mcp tools > learning_neighbors returns at least one neighbor with similarity_score 51ms
 ✓ test/mcp-tools.test.ts > mcp tools > list returns learnings for a scope 73ms
 ✓ test/mcp-tools.test.ts > mcp tools > stats returns totals and scope data 3ms
 ✓ test/mcp-tools.test.ts > mcp tools > state_put stores state and starts at revision 1 16ms
 ✓ test/mcp-tools.test.ts > mcp tools > state_get returns the stored goal 15ms
 ✓ test/mcp-tools.test.ts > mcp tools > state_patch updates state and increments revision 26ms
 ✓ test/mcp-tools.test.ts > mcp tools > state_resolve resolves run and can persist learning 47ms
 ✓ test/mcp-tools.test.ts > mcp error handling > invalid JSON-RPC version returns -32600 4ms
 ✓ test/mcp-tools.test.ts > mcp error handling > unknown method returns -32601 1ms
 ✓ test/mcp-tools.test.ts > mcp error handling > unknown tool name returns tool error 2ms
 ✓ test/mcp-tools.test.ts > mcp error handling > missing tool name returns tool error 1ms
 ✓ test/mcp-tools.test.ts > mcp protocol > notifications/initialized returns 204 1ms
 ✓ test/mcp-tools.test.ts > mcp protocol > GET /mcp returns info and all 13 tools 5ms
 ✓ test/state-extended.test.ts > state extended edge cases > GET non-existent state returns 404 4ms
 ✓ test/state-extended.test.ts > state extended edge cases > revision tracking increments for PUT + PATCH + PATCH 52ms
 ✓ test/state-extended.test.ts > state extended edge cases > multiple patches accumulate merged state fields 42ms
 ✓ test/state-extended.test.ts > state extended edge cases > resolving an already resolved state returns 200 again 93ms
 ✓ test/state-extended.test.ts > state extended edge cases > persistToLearn=false does not create a learning 21ms
 ✓ test/state-extended.test.ts > state extended edge cases > events creation returns unique ids 33ms
 ✓ test/secrets-extended.test.ts > secrets extended > upserts existing secret value for the same name and scope 27ms
 ✓ test/secrets-extended.test.ts > secrets extended > returns 404 when getting a non-existent secret 2ms
 ✓ test/secrets-extended.test.ts > secrets extended > uses session scope priority over shared when resolving a secret 25ms
 ✓ test/secrets-extended.test.ts > secrets extended > lists all secrets without a scope filter 16ms
 ✓ test/secrets-extended.test.ts > secrets extended > omits deleted secret from scoped list results 10ms
stdout | test/negative.test.ts > auth edge cases > malformed auth header documents actual status
MALFORMED_AUTH_STATUS=401

 ✓ test/negative.test.ts > validation errors > POST /learn missing trigger returns 400 5ms
 ✓ test/negative.test.ts > validation errors > POST /learn missing learning returns 400 2ms
 ✓ test/negative.test.ts > validation errors > POST /inject empty body returns 400 1ms
 ✓ test/negative.test.ts > not-found behaviors > GET /learning/:id/neighbors for nonexistent id 2ms
 ✓ test/negative.test.ts > not-found behaviors > DELETE /learning/:id for nonexistent id is idempotent 1ms
 ✓ test/negative.test.ts > not-found behaviors > GET unknown route returns 404 2ms
 ✓ test/negative.test.ts > auth edge cases > wrong API key returns 401 1ms
 ✓ test/negative.test.ts > auth edge cases > malformed auth header documents actual status 1ms
 ✓ test/negative.test.ts > cleanup endpoint > POST /cleanup returns cleanup result 3ms
 ✓ test/negative.test.ts > cleanup endpoint > cleanup removes low-confidence learnings 57ms

 Test Files  6 passed (6)
      Tests  65 passed (65)
   Start at  10:11:49
   Duration  6.48s (transform 64ms, setup 0ms, collect 83ms, tests 6.28s, environment 0ms, prepare 31ms)

